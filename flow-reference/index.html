
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Progressive Prefect 3 examples â€” from hello-world to production patterns.">
      
      
      
      
        <link rel="prev" href="../core-concepts/">
      
      
        <link rel="next" href="../patterns/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>Flow Reference - Prefect Examples</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#flow-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Prefect Examples" class="md-header__button md-logo" aria-label="Prefect Examples" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Prefect Examples
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Flow Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/mortenoh/prefect-examples" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Prefect Examples" class="md-nav__button md-logo" aria-label="Prefect Examples" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Prefect Examples
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mortenoh/prefect-examples" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Flow Reference
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Flow Reference
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Basics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hello-world" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hello World
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Python Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Dependencies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#taskflow-etl" class="md-nav__link">
    <span class="md-ellipsis">
      
        Taskflow ETL
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Results
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#control-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Control Flow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Control Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conditional-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conditional Logic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      
        State Handlers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameterized-flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameterized Flows
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition" class="md-nav__link">
    <span class="md-ellipsis">
      
        Composition
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Composition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#subflows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Subflows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dynamic Tasks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operational" class="md-nav__link">
    <span class="md-ellipsis">
      
        Operational
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operational">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#polling-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Polling Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retries-and-hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retries and Hooks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reuse-and-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reuse and Events
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reuse and Events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reusable-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reusable Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    <span class="md-ellipsis">
      
        Events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flow-of-flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow of Flows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrency-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Concurrency Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variables-and-params" class="md-nav__link">
    <span class="md-ellipsis">
      
        Variables and Params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#early-return" class="md-nav__link">
    <span class="md-ellipsis">
      
        Early Return
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context-managers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Context Managers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complex-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complex Pipeline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-level-configuration-021-024" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task-Level Configuration (021--024)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task-Level Configuration (021--024)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-caching" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Caching
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-timeouts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Timeouts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-run-names" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Run Names
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-retries" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Retries
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flow-level-configuration-025-028" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow-Level Configuration (025--028)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flow-Level Configuration (025--028)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#structured-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Structured Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tags" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tags
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-run-names" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow Run Names
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#result-persistence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Result Persistence
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#artifacts-and-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Artifacts and Blocks
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Artifacts and Blocks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#markdown-artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Markdown Artifacts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-and-link-artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table and Link Artifacts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secret-block" class="md-nav__link">
    <span class="md-ellipsis">
      
        Secret Block
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Blocks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Async Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#async-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrent-async" class="md-nav__link">
    <span class="md-ellipsis">
      
        Concurrent Async
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-flow-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async Flow Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-map-and-submit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async Map and Submit
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-and-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deployment and Scheduling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployment and Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flow-serve" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow Serve
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schedules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Schedules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#work-pools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Work Pools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Pipeline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic-and-data-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pydantic and Data Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pydantic and Data Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pydantic-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pydantic Models
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shell Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTP Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-factories" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Factories
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-mapping-and-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Mapping and Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Mapping and Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#advanced-map-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Map Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-etl" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling ETL
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pydantic-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pydantic Validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sla-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        SLA Monitoring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notifications-and-observability" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notifications and Observability
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Notifications and Observability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#webhook-notifications" class="md-nav__link">
    <span class="md-ellipsis">
      
        Webhook Notifications
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notification-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notification Blocks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webhook-block" class="md-nav__link">
    <span class="md-ellipsis">
      
        Webhook Block
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#failure-escalation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Failure Escalation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testable-flow-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testable Flow Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reusable-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reusable Utilities
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition-and-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Composition and Scheduling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Composition and Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#advanced-state-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced State Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nested-subflows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Nested Subflows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backfill-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backfill Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtime-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Runtime Context
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features-and-capstone" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Features and Capstone
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features and Capstone">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transactions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Transactions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Interactive Flows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-runners" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Runners
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-pipeline-v2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Pipeline v2
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-io-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        File I/O Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="File I/O Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#csv-file-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        CSV File Processing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-event-ingestion" class="md-nav__link">
    <span class="md-ellipsis">
      
        JSON Event Ingestion
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-file-batch-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-File Batch Processing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incremental-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Incremental Processing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-quality-framework" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Quality Framework
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Quality Framework">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quality-rules-engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quality Rules Engine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-dataset-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cross-Dataset Validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Profiling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline-health-monitor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pipeline Health Monitor
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-orchestration-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Orchestration Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Orchestration Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-source-forecast" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-Source Forecast
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-pagination" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Pagination
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-source-enrichment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cross-Source Enrichment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#response-caching" class="md-nav__link">
    <span class="md-ellipsis">
      
        Response Caching
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-and-orchestration-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration and Orchestration Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration and Orchestration Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#config-driven-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Config-Driven Pipeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#producer-consumer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Producer-Consumer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#circuit-breaker" class="md-nav__link">
    <span class="md-ellipsis">
      
        Circuit Breaker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discriminated-unions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Discriminated Unions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#production-patterns-and-capstone" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Patterns and Capstone
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Production Patterns and Capstone">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#streaming-batch-processor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Streaming Batch Processor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotent-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Idempotent Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Recovery
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-pipeline-v3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Pipeline v3
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environmental-and-risk-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environmental and Risk Analysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Environmental and Risk Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#air-quality-index" class="md-nav__link">
    <span class="md-ellipsis">
      
        Air Quality Index
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composite-risk-assessment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Composite Risk Assessment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#daylight-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Daylight Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statistical-aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Statistical Aggregation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#economic-and-demographic-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Economic and Demographic Analysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Economic and Demographic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#demographic-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Demographic Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-indicator-correlation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-Indicator Correlation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#financial-time-series" class="md-nav__link">
    <span class="md-ellipsis">
      
        Financial Time Series
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hypothesis-testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hypothesis Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-analytics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Analytics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Analytics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#regression-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Regression Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#star-schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        Star Schema
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#staged-etl-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Staged ETL Pipeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-transfer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Transfer
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#domain-api-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Domain API Processing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Domain API Processing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hierarchical-data-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hierarchical Data Processing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expression-complexity-scoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Expression Complexity Scoring
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spatial-data-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Spatial Data Construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-multi-endpoint-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parallel Multi-Endpoint Export
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-patterns-and-grand-capstone" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Patterns and Grand Capstone
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Patterns and Grand Capstone">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-lineage-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Lineage Tracking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline-template-factory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pipeline Template Factory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-pipeline-orchestrator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-Pipeline Orchestrator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grand-capstone" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grand Capstone
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dhis2-integration-101-108" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Integration (101--108)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DHIS2 Integration (101--108)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dhis2-connection-block" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Connection Block
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-block-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Block Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-org-units-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Org Units API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-data-elements-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Data Elements API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-indicators-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Indicators API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-org-unit-geometry" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Org Unit Geometry
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-combined-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Combined Export
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-analytics-query" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Analytics Query
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-full-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Full Pipeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-world-bank-population-import" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 World Bank Population Import
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-world-bank-health-indicators-import" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 World Bank Health Indicators Import
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-worldpop-population-import" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 WorldPop Population Import
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connection-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connection Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Connection Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-based-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment-Based Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authenticated-api-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authenticated API Pipeline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloud-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloud Storage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cloud Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s3-parquet-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        S3 Parquet Export
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-geoparquet-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 GeoParquet Export
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldpop-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorldPop API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#worldpop-dataset-catalog" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Dataset Catalog
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-population-stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Population Stats
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-age-sex-pyramid" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Age-Sex Pyramid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-country-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Country Comparison
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-country-report" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Country Report
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-population-time-series" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Population Time-Series
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world-bank-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="World Bank API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world-bank-gdp-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank GDP Comparison
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world-bank-indicator-time-series" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank Indicator Time-Series
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world-bank-country-profile" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank Country Profile
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world-bank-poverty-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank Poverty Analysis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployments-directory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deployments directory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployments directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dhis2_connection-dhis2-connection-check" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_connection -- DHIS2 Connection Check
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2_block_connection-dhis2-block-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_block_connection -- DHIS2 Block Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2_ou-dhis2-organisation-units" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_ou -- DHIS2 Organisation Units
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s3_parquet_export-s3-parquet-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        s3_parquet_export -- S3 Parquet Export
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2_geoparquet_export-dhis2-geoparquet-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_geoparquet_export -- DHIS2 GeoParquet Export
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2_worldpop_population_import-dhis2-worldpop-population-import" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_worldpop_population_import -- DHIS2 WorldPop Population Import
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../feature-coverage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Feature Coverage
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Infrastructure
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Basics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hello-world" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hello World
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Python Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Dependencies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#taskflow-etl" class="md-nav__link">
    <span class="md-ellipsis">
      
        Taskflow ETL
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Results
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#control-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Control Flow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Control Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conditional-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conditional Logic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      
        State Handlers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameterized-flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameterized Flows
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition" class="md-nav__link">
    <span class="md-ellipsis">
      
        Composition
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Composition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#subflows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Subflows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dynamic Tasks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operational" class="md-nav__link">
    <span class="md-ellipsis">
      
        Operational
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operational">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#polling-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Polling Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retries-and-hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retries and Hooks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reuse-and-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reuse and Events
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reuse and Events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reusable-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reusable Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    <span class="md-ellipsis">
      
        Events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flow-of-flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow of Flows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrency-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Concurrency Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variables-and-params" class="md-nav__link">
    <span class="md-ellipsis">
      
        Variables and Params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#early-return" class="md-nav__link">
    <span class="md-ellipsis">
      
        Early Return
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context-managers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Context Managers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complex-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complex Pipeline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-level-configuration-021-024" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task-Level Configuration (021--024)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task-Level Configuration (021--024)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-caching" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Caching
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-timeouts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Timeouts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-run-names" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Run Names
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-retries" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Retries
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flow-level-configuration-025-028" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow-Level Configuration (025--028)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flow-Level Configuration (025--028)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#structured-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Structured Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tags" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tags
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-run-names" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow Run Names
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#result-persistence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Result Persistence
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#artifacts-and-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Artifacts and Blocks
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Artifacts and Blocks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#markdown-artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Markdown Artifacts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-and-link-artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table and Link Artifacts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secret-block" class="md-nav__link">
    <span class="md-ellipsis">
      
        Secret Block
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Blocks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Async Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#async-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrent-async" class="md-nav__link">
    <span class="md-ellipsis">
      
        Concurrent Async
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-flow-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async Flow Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-map-and-submit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async Map and Submit
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-and-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deployment and Scheduling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployment and Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flow-serve" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow Serve
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schedules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Schedules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#work-pools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Work Pools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Pipeline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic-and-data-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pydantic and Data Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pydantic and Data Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pydantic-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pydantic Models
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shell Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTP Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-factories" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Factories
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-mapping-and-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Mapping and Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Mapping and Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#advanced-map-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Map Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-etl" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling ETL
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pydantic-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pydantic Validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sla-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        SLA Monitoring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notifications-and-observability" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notifications and Observability
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Notifications and Observability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#webhook-notifications" class="md-nav__link">
    <span class="md-ellipsis">
      
        Webhook Notifications
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notification-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notification Blocks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webhook-block" class="md-nav__link">
    <span class="md-ellipsis">
      
        Webhook Block
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#failure-escalation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Failure Escalation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testable-flow-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testable Flow Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reusable-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reusable Utilities
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition-and-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Composition and Scheduling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Composition and Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#advanced-state-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced State Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nested-subflows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Nested Subflows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backfill-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backfill Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtime-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Runtime Context
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features-and-capstone" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Features and Capstone
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features and Capstone">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transactions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Transactions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Interactive Flows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-runners" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Runners
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-pipeline-v2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Pipeline v2
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-io-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        File I/O Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="File I/O Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#csv-file-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        CSV File Processing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-event-ingestion" class="md-nav__link">
    <span class="md-ellipsis">
      
        JSON Event Ingestion
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-file-batch-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-File Batch Processing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incremental-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Incremental Processing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-quality-framework" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Quality Framework
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Quality Framework">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quality-rules-engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quality Rules Engine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-dataset-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cross-Dataset Validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Profiling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline-health-monitor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pipeline Health Monitor
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-orchestration-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Orchestration Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Orchestration Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-source-forecast" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-Source Forecast
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-pagination" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Pagination
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-source-enrichment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cross-Source Enrichment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#response-caching" class="md-nav__link">
    <span class="md-ellipsis">
      
        Response Caching
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-and-orchestration-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration and Orchestration Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration and Orchestration Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#config-driven-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Config-Driven Pipeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#producer-consumer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Producer-Consumer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#circuit-breaker" class="md-nav__link">
    <span class="md-ellipsis">
      
        Circuit Breaker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discriminated-unions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Discriminated Unions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#production-patterns-and-capstone" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Patterns and Capstone
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Production Patterns and Capstone">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#streaming-batch-processor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Streaming Batch Processor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotent-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Idempotent Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Recovery
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-pipeline-v3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Pipeline v3
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environmental-and-risk-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environmental and Risk Analysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Environmental and Risk Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#air-quality-index" class="md-nav__link">
    <span class="md-ellipsis">
      
        Air Quality Index
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composite-risk-assessment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Composite Risk Assessment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#daylight-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Daylight Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statistical-aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Statistical Aggregation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#economic-and-demographic-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Economic and Demographic Analysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Economic and Demographic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#demographic-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Demographic Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-indicator-correlation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-Indicator Correlation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#financial-time-series" class="md-nav__link">
    <span class="md-ellipsis">
      
        Financial Time Series
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hypothesis-testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hypothesis Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-analytics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Analytics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Analytics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#regression-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Regression Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#star-schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        Star Schema
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#staged-etl-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Staged ETL Pipeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-transfer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Transfer
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#domain-api-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Domain API Processing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Domain API Processing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hierarchical-data-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hierarchical Data Processing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expression-complexity-scoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Expression Complexity Scoring
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spatial-data-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Spatial Data Construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-multi-endpoint-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parallel Multi-Endpoint Export
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-patterns-and-grand-capstone" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Patterns and Grand Capstone
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Patterns and Grand Capstone">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-lineage-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Lineage Tracking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline-template-factory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pipeline Template Factory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-pipeline-orchestrator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-Pipeline Orchestrator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grand-capstone" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grand Capstone
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dhis2-integration-101-108" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Integration (101--108)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DHIS2 Integration (101--108)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dhis2-connection-block" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Connection Block
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-block-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Block Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-org-units-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Org Units API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-data-elements-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Data Elements API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-indicators-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Indicators API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-org-unit-geometry" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Org Unit Geometry
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-combined-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Combined Export
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-analytics-query" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Analytics Query
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-full-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 Full Pipeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-world-bank-population-import" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 World Bank Population Import
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-world-bank-health-indicators-import" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 World Bank Health Indicators Import
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-worldpop-population-import" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 WorldPop Population Import
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connection-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connection Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Connection Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-based-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment-Based Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authenticated-api-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authenticated API Pipeline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloud-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloud Storage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cloud Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s3-parquet-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        S3 Parquet Export
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2-geoparquet-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        DHIS2 GeoParquet Export
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldpop-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorldPop API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#worldpop-dataset-catalog" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Dataset Catalog
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-population-stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Population Stats
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-age-sex-pyramid" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Age-Sex Pyramid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-country-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Country Comparison
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-country-report" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Country Report
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worldpop-population-time-series" class="md-nav__link">
    <span class="md-ellipsis">
      
        WorldPop Population Time-Series
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#world-bank-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="World Bank API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#world-bank-gdp-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank GDP Comparison
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world-bank-indicator-time-series" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank Indicator Time-Series
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world-bank-country-profile" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank Country Profile
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#world-bank-poverty-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        World Bank Poverty Analysis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployments-directory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deployments directory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployments directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dhis2_connection-dhis2-connection-check" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_connection -- DHIS2 Connection Check
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2_block_connection-dhis2-block-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_block_connection -- DHIS2 Block Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2_ou-dhis2-organisation-units" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_ou -- DHIS2 Organisation Units
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s3_parquet_export-s3-parquet-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        s3_parquet_export -- S3 Parquet Export
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2_geoparquet_export-dhis2-geoparquet-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_geoparquet_export -- DHIS2 GeoParquet Export
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhis2_worldpop_population_import-dhis2-worldpop-population-import" class="md-nav__link">
    <span class="md-ellipsis">
      
        dhis2_worldpop_population_import -- DHIS2 WorldPop Population Import
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="flow-reference">Flow Reference<a class="headerlink" href="#flow-reference" title="Permanent link">&para;</a></h1>
<p>Detailed walkthrough of all 113 example flows, organised by category.</p>
<hr />
<h2 id="basics">Basics<a class="headerlink" href="#basics" title="Permanent link">&para;</a></h2>
<h3 id="hello-world">Hello World<a class="headerlink" href="#hello-world" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> The simplest possible Prefect flow -- two tasks
executed sequentially.</p>
<p><strong>Airflow equivalent:</strong> BashOperator tasks with <code>&gt;&gt;</code> dependency.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nd">@task</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">say_hello</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Hello from Prefect!&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_hello_world&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">hello_world</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">say_hello</span><span class="p">()</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">print_date</span><span class="p">()</span>
</code></pre></div>
<p>Tasks are plain Python functions. Call them inside a <code>@flow</code> and Prefect tracks
everything automatically.</p>
<hr />
<h3 id="python-tasks">Python Tasks<a class="headerlink" href="#python-tasks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Tasks with typed parameters and return values.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator with <code>python_callable</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nd">@task</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">greeting</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Hello&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">greeting</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="nd">@task</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_sum</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<p>Any Python function becomes a task with <code>@task</code> -- type hints, defaults, and
docstrings all work as expected.</p>
<hr />
<h3 id="task-dependencies">Task Dependencies<a class="headerlink" href="#task-dependencies" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Parallel fan-out with <code>.submit()</code> and a join step.</p>
<p><strong>Airflow equivalent:</strong> <code>&gt;&gt;</code> operator / <code>set_downstream</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_task_dependencies&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">task_dependencies_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">initial</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">future_a</span> <span class="o">=</span> <span class="n">task_a</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">future_b</span> <span class="o">=</span> <span class="n">task_b</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="n">future_c</span> <span class="o">=</span> <span class="n">task_c</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="n">join</span><span class="p">([</span><span class="n">future_a</span><span class="o">.</span><span class="n">result</span><span class="p">(),</span> <span class="n">future_b</span><span class="o">.</span><span class="n">result</span><span class="p">(),</span> <span class="n">future_c</span><span class="o">.</span><span class="n">result</span><span class="p">()])</span>
</code></pre></div>
<p><code>.submit()</code> launches tasks concurrently. Call <code>.result()</code> to wait for their
outputs before passing them downstream.</p>
<hr />
<h3 id="taskflow-etl">Taskflow ETL<a class="headerlink" href="#taskflow-etl" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Classic extract-transform-load wired through return
values.</p>
<p><strong>Airflow equivalent:</strong> TaskFlow API (<code>@task</code>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_taskflow_etl&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">taskflow_etl_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="n">extract</span><span class="p">()</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="n">transformed</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="n">load</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
</code></pre></div>
<p>Prefect is natively taskflow-first. Each task returns data and the next task
receives it -- no XCom needed.</p>
<hr />
<h3 id="task-results">Task Results<a class="headerlink" href="#task-results" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Passing structured data (dicts, lists) between tasks.</p>
<p><strong>Airflow equivalent:</strong> XCom push/pull.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nd">@task</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">produce_metrics</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">:</span> <span class="mf">37.5</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;delta&quot;</span><span class="p">]}</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="nd">@task</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">consume_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Total: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Average: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="k">return</span> <span class="n">summary</span>
</code></pre></div>
<p>Return values replace XCom entirely. Pass dicts, lists, or any serialisable
object between tasks.</p>
<hr />
<h2 id="control-flow">Control Flow<a class="headerlink" href="#control-flow" title="Permanent link">&para;</a></h2>
<h3 id="conditional-logic">Conditional Logic<a class="headerlink" href="#conditional-logic" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Branching with plain Python <code>if/elif/else</code>.</p>
<p><strong>Airflow equivalent:</strong> BranchPythonOperator.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_conditional_logic&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">conditional_logic_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">branch</span> <span class="o">=</span> <span class="n">check_condition</span><span class="p">()</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="k">if</span> <span class="n">branch</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        <span class="n">path_a</span><span class="p">()</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="k">elif</span> <span class="n">branch</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="n">path_b</span><span class="p">()</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="n">default_path</span><span class="p">()</span>
</code></pre></div>
<p>No special operators needed. Python control flow works directly inside flows.</p>
<hr />
<h3 id="state-handlers">State Handlers<a class="headerlink" href="#state-handlers" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Reacting to task/flow state changes with hook
functions, and continuing past failures with <code>allow_failure</code>.</p>
<p><strong>Airflow equivalent:</strong> <code>on_failure_callback</code> / trigger_rule.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">on_failure</span><span class="o">=</span><span class="p">[</span><span class="n">on_task_failure</span><span class="p">])</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">fail_task</span><span class="p">():</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Intentional failure for demonstration&quot;</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_state_handlers&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_completion</span><span class="o">=</span><span class="p">[</span><span class="n">on_flow_completion</span><span class="p">])</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">state_handlers_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="n">succeed_task</span><span class="p">()</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    <span class="n">failing_future</span> <span class="o">=</span> <span class="n">fail_task</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="n">always_run_task</span><span class="p">(</span><span class="n">wait_for</span><span class="o">=</span><span class="p">[</span><span class="n">allow_failure</span><span class="p">(</span><span class="n">failing_future</span><span class="p">)])</span>
</code></pre></div>
<p>Hooks are plain functions (not tasks) that receive <code>task</code>, <code>task_run</code>, and
<code>state</code>. <code>allow_failure</code> lets downstream tasks run even when upstream tasks
fail.</p>
<hr />
<h3 id="parameterized-flows">Parameterized Flows<a class="headerlink" href="#parameterized-flows" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Runtime parameters with typed defaults.</p>
<p><strong>Airflow equivalent:</strong> Jinja2 templating / params dict.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_parameterized_flows&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">parameterized_flow</span><span class="p">(</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;World&quot;</span><span class="p">,</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="n">date_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="n">template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Greetings, </span><span class="si">{name}</span><span class="s2">! Today is </span><span class="si">{date}</span><span class="s2">.&quot;</span><span class="p">,</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="k">if</span> <span class="n">date_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>        <span class="n">date_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="n">build_greeting</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">date_str</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</code></pre></div>
<p>Flow parameters are regular Python function arguments. Type hints and defaults
are preserved in the Prefect UI when the flow is deployed.</p>
<hr />
<h2 id="composition">Composition<a class="headerlink" href="#composition" title="Permanent link">&para;</a></h2>
<h3 id="subflows">Subflows<a class="headerlink" href="#subflows" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Composing larger pipelines from smaller, reusable
flows.</p>
<p><strong>Airflow equivalent:</strong> TaskGroup / SubDagOperator.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_subflows&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">pipeline_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="n">extract_flow</span><span class="p">()</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">transformed</span> <span class="o">=</span> <span class="n">transform_flow</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="n">load_flow</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
</code></pre></div>
<p>A <code>@flow</code> can call other <code>@flow</code> functions. Each subflow appears as a nested
flow run in the Prefect UI with its own state tracking.</p>
<hr />
<h3 id="dynamic-tasks">Dynamic Tasks<a class="headerlink" href="#dynamic-tasks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Dynamic fan-out over a list of items with <code>.map()</code>.</p>
<p><strong>Airflow equivalent:</strong> Dynamic task mapping (<code>expand()</code>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_dynamic_tasks&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dynamic_tasks_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="n">items</span> <span class="o">=</span> <span class="n">generate_items</span><span class="p">()</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="n">processed</span> <span class="o">=</span> <span class="n">process_item</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="n">summarize</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
</code></pre></div>
<p><code>.map()</code> creates one task run per item. The number of items can vary at
runtime -- no DAG rewrite required.</p>
<hr />
<h2 id="operational">Operational<a class="headerlink" href="#operational" title="Permanent link">&para;</a></h2>
<h3 id="polling-tasks">Polling Tasks<a class="headerlink" href="#polling-tasks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Waiting for an external condition with a polling
loop.</p>
<p><strong>Airflow equivalent:</strong> Sensor (poke/reschedule).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nd">@task</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">poll_condition</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>                   <span class="n">succeed_after</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">succeed_after</span><span class="p">:</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">] Condition met after </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">:</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">] Timed out after </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
</code></pre></div>
<p>No special sensor class needed. A <code>while</code> loop with <code>time.sleep()</code> inside a
task accomplishes the same thing.</p>
<hr />
<h3 id="retries-and-hooks">Retries and Hooks<a class="headerlink" href="#retries-and-hooks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Automatic retries and lifecycle hooks on tasks and
flows.</p>
<p><strong>Airflow equivalent:</strong> <code>retries</code> + <code>on_failure_callback</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">on_failure</span><span class="o">=</span><span class="p">[</span><span class="n">my_task_failure_hook</span><span class="p">])</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">flaky_task</span><span class="p">(</span><span class="n">fail_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;flaky_task&quot;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">_attempt_counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_attempt_counter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">attempt</span> <span class="o">=</span> <span class="n">_attempt_counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;=</span> <span class="n">fail_count</span><span class="p">:</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fail_count</span><span class="si">}</span><span class="s2"> â€” simulated failure&quot;</span><span class="p">)</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;flaky_task succeeded on attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p><code>retries</code> and <code>retry_delay_seconds</code> are set on the decorator. Hooks fire on
state transitions for logging or alerting.</p>
<hr />
<h2 id="reuse-and-events">Reuse and Events<a class="headerlink" href="#reuse-and-events" title="Permanent link">&para;</a></h2>
<h3 id="reusable-tasks">Reusable Tasks<a class="headerlink" href="#reusable-tasks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Importing shared tasks from a project task library.</p>
<p><strong>Airflow equivalent:</strong> Custom operators / shared utils.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect_examples.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_message</span><span class="p">,</span> <span class="n">square_number</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_reusable_tasks&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">reusable_tasks_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    <span class="n">print_message</span><span class="p">(</span><span class="s2">&quot;Hello from reusable tasks!&quot;</span><span class="p">)</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">square_number</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</code></pre></div>
<p>Tasks are just Python functions. Import them from a shared module and call them
in any flow. The shared library lives in <code>src/prefect_examples/tasks.py</code>.</p>
<hr />
<h3 id="events">Events<a class="headerlink" href="#events" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Emitting custom Prefect events for observability and
automation triggers.</p>
<p><strong>Airflow equivalent:</strong> Custom XCom + trigger rules.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nd">@task</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">emit_completion_event</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="n">emit_event</span><span class="p">(</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>        <span class="n">event</span><span class="o">=</span><span class="s2">&quot;flow.data.produced&quot;</span><span class="p">,</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>        <span class="n">resource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;prefect.resource.id&quot;</span><span class="p">:</span> <span class="s2">&quot;prefect_examples.014&quot;</span><span class="p">},</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">},</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="p">)</span>
</code></pre></div>
<p><code>emit_event()</code> sends custom events to the Prefect event system. These can
trigger automations, dashboards, or downstream workflows.</p>
<hr />
<h2 id="advanced">Advanced<a class="headerlink" href="#advanced" title="Permanent link">&para;</a></h2>
<h3 id="flow-of-flows">Flow of Flows<a class="headerlink" href="#flow-of-flows" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Orchestrating multiple flows from a parent flow.</p>
<p><strong>Airflow equivalent:</strong> TriggerDagRunOperator.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_flow_of_flows&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">orchestrator</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="n">ingest_flow</span><span class="p">()</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="n">processed</span> <span class="o">=</span> <span class="n">transform_flow</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="n">summary</span> <span class="o">=</span> <span class="n">report_flow</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipeline complete: </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>The orchestrator calls subflows (ingest, transform, report) in sequence. Each
subflow is independently testable and reusable. For deployed flows, use
<code>run_deployment()</code> to trigger remote execution.</p>
<hr />
<h3 id="concurrency-limits">Concurrency Limits<a class="headerlink" href="#concurrency-limits" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Throttling parallel task execution with named limits.</p>
<p><strong>Airflow equivalent:</strong> Pool slots.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nd">@task</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">limited_task</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="k">with</span> <span class="n">concurrency</span><span class="p">(</span><span class="s2">&quot;demo-limit&quot;</span><span class="p">,</span> <span class="n">occupy</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">item</span><span class="si">!r}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;processed:</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p>The <code>concurrency()</code> context manager from <code>prefect.concurrency.sync</code> limits how
many tasks can enter a critical section simultaneously. The limit name
(<code>"demo-limit"</code>) is shared across all task runs.</p>
<hr />
<h3 id="variables-and-params">Variables and Params<a class="headerlink" href="#variables-and-params" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Storing and retrieving runtime configuration.</p>
<p><strong>Airflow equivalent:</strong> Variables + params.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nd">@task</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="n">Variable</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;example_config&quot;</span><span class="p">,</span> <span class="s1">&#39;{&quot;debug&quot;: true, &quot;batch_size&quot;: 100}&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;example_config&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div>
<p><code>Variable.get()</code> and <code>Variable.set()</code> store key-value pairs in the Prefect
backend. Combine with typed flow parameters for full runtime configuration.</p>
<hr />
<h3 id="early-return">Early Return<a class="headerlink" href="#early-return" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Short-circuiting a flow with a plain <code>return</code>.</p>
<p><strong>Airflow equivalent:</strong> ShortCircuitOperator.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_early_return&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">early_return_flow</span><span class="p">(</span><span class="n">skip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skip flag is set â€” returning early&quot;</span><span class="p">)</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>        <span class="k">return</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="n">proceed</span> <span class="o">=</span> <span class="n">should_continue</span><span class="p">()</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">proceed</span><span class="p">:</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>        <span class="k">return</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="n">do_work</span><span class="p">()</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="n">do_more_work</span><span class="p">()</span>
</code></pre></div>
<p>No special operator. A Python <code>return</code> statement exits the flow early and
marks it as <code>Completed</code>.</p>
<hr />
<h3 id="context-managers">Context Managers<a class="headerlink" href="#context-managers" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Resource setup and teardown with <code>try/finally</code>.</p>
<p><strong>Airflow equivalent:</strong> <code>@setup</code> / <code>@teardown</code> decorators.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_context_managers&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">context_managers_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="n">resource</span> <span class="o">=</span> <span class="n">setup_resource</span><span class="p">()</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>        <span class="n">use_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>        <span class="n">cleanup_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</code></pre></div>
<p>Standard Python resource management patterns (context managers, <code>try/finally</code>)
work inside flows and guarantee teardown even on failure.</p>
<hr />
<h3 id="complex-pipeline">Complex Pipeline<a class="headerlink" href="#complex-pipeline" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> End-to-end pipeline combining subflows, mapped tasks,
and notifications.</p>
<p><strong>Airflow equivalent:</strong> Complex DAG with branching, sensors, callbacks.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_complex_pipeline&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">complex_pipeline</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="n">extract_stage</span><span class="p">()</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="n">transformed</span> <span class="o">=</span> <span class="n">transform_stage</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>    <span class="n">summary</span> <span class="o">=</span> <span class="n">load_stage</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="n">notify</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</code></pre></div>
<p>The transform stage uses chained <code>.map()</code> calls:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;basics_transform&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">transform_stage</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>    <span class="n">validated</span> <span class="o">=</span> <span class="n">validate_record</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    <span class="n">enriched</span> <span class="o">=</span> <span class="n">enrich_record</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">validated</span><span class="p">)</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">enriched</span><span class="p">]</span>
</code></pre></div>
<p>This is the capstone flow for Phase 1, demonstrating how subflows, mapped tasks,
result passing, and post-pipeline notifications compose into a realistic data
pipeline.</p>
<hr />
<h2 id="task-level-configuration-021-024">Task-Level Configuration (021--024)<a class="headerlink" href="#task-level-configuration-021-024" title="Permanent link">&para;</a></h2>
<h3 id="task-caching">Task Caching<a class="headerlink" href="#task-caching" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Task-level caching to avoid redundant computation.</p>
<p><strong>Airflow equivalent:</strong> Custom caching logic or external cache (Redis, etc.).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect.cache_policies</span><span class="w"> </span><span class="kn">import</span> <span class="n">INPUTS</span><span class="p">,</span> <span class="n">TASK_SOURCE</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="nd">@task</span><span class="p">(</span><span class="n">cache_policy</span><span class="o">=</span><span class="n">INPUTS</span><span class="p">,</span> <span class="n">cache_expiration</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">expensive_computation</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="nd">@task</span><span class="p">(</span><span class="n">cache_policy</span><span class="o">=</span><span class="n">TASK_SOURCE</span> <span class="o">+</span> <span class="n">INPUTS</span><span class="p">)</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">compound_cache_task</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="nd">@task</span><span class="p">(</span><span class="n">cache_key_fn</span><span class="o">=</span><span class="n">_category_cache_key</span><span class="p">,</span> <span class="n">cache_expiration</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">cached_lookup</span><span class="p">(</span><span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span> <span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="n">item_id</span><span class="p">}</span>
</code></pre></div>
<p>Three caching strategies: <code>INPUTS</code> (cache by arguments), <code>TASK_SOURCE + INPUTS</code>
(invalidate when code or args change), and <code>cache_key_fn</code> for custom cache keys.
Cache hits are only visible in Prefect runtime.</p>
<hr />
<h3 id="task-timeouts">Task Timeouts<a class="headerlink" href="#task-timeouts" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Task-level and flow-level timeout configuration.</p>
<p><strong>Airflow equivalent:</strong> <code>execution_timeout</code> on operators.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">quick_task</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="k">return</span> <span class="s2">&quot;completed in time&quot;</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="nd">@task</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">slow_task</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Will be interrupted by timeout</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="k">return</span> <span class="s2">&quot;completed&quot;</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;core_task_timeouts&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">task_timeouts_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>    <span class="n">quick_task</span><span class="p">()</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>        <span class="n">slow_task</span><span class="p">()</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>        <span class="n">cleanup_task</span><span class="p">(</span><span class="n">timed_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p><code>timeout_seconds</code> on <code>@task</code> or <code>@flow</code> kills execution that exceeds the limit.
The flow catches the timeout and runs cleanup. Note: <code>.fn()</code> bypasses timeouts.</p>
<hr />
<h3 id="task-run-names">Task Run Names<a class="headerlink" href="#task-run-names" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Custom task run naming using templates and callables.</p>
<p><strong>Airflow equivalent:</strong> <code>task_id</code> / custom logging for operator identification.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">task_run_name</span><span class="o">=</span><span class="s2">&quot;fetch-</span><span class="si">{source}</span><span class="s2">-page-</span><span class="si">{page}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">fetch_data</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span> <span class="s2">&quot;records&quot;</span><span class="p">:</span> <span class="n">page</span> <span class="o">*</span> <span class="mi">10</span><span class="p">}</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_task_name</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">task_run</span><span class="o">.</span><span class="n">parameters</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;process-</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-batch-</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;batch_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="nd">@task</span><span class="p">(</span><span class="n">task_run_name</span><span class="o">=</span><span class="n">generate_task_name</span><span class="p">)</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_batch</span><span class="p">(</span><span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Processed batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2"> for region </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p>Template strings use parameter names in braces. Callables access
<code>prefect.runtime.task_run.parameters</code> for dynamic naming.</p>
<hr />
<h3 id="advanced-retries">Advanced Retries<a class="headerlink" href="#advanced-retries" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Advanced retry configuration: backoff, jitter, and
conditional retry logic.</p>
<p><strong>Airflow equivalent:</strong> Custom retry logic, <code>exponential_backoff</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">backoff_task</span><span class="p">(</span><span class="n">fail_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">retry_jitter_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">jittery_task</span><span class="p">(</span><span class="n">fail_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">retry_on_value_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_run</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">raise_on_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="ne">ValueError</span><span class="p">)</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retry_condition_fn</span><span class="o">=</span><span class="n">retry_on_value_error</span><span class="p">)</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">conditional_retry_task</span><span class="p">(</span><span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<p><code>retry_delay_seconds</code> accepts a list for escalating delays. <code>retry_jitter_factor</code>
adds randomness to prevent thundering herd. <code>retry_condition_fn</code> controls which
errors trigger retries.</p>
<hr />
<h2 id="flow-level-configuration-025-028">Flow-Level Configuration (025--028)<a class="headerlink" href="#flow-level-configuration-025-028" title="Permanent link">&para;</a></h2>
<h3 id="structured-logging">Structured Logging<a class="headerlink" href="#structured-logging" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Prefect's structured logging with <code>get_run_logger()</code>,
print capture, and extra context fields.</p>
<p><strong>Airflow equivalent:</strong> Python logging in operators, task instance logger.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_run_logger</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="nd">@task</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">task_with_logger</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_run_logger</span><span class="p">()</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;processed:</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="nd">@task</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">task_with_extra_context</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_run_logger</span><span class="p">()</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Action performed&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">})</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2"> performed </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p><code>get_run_logger()</code> returns a logger bound to the current run. Outside Prefect
runtime it falls back to stdlib logging. With <code>log_prints=True</code>, <code>print()</code>
output is captured as INFO-level log entries.</p>
<hr />
<h3 id="tags">Tags<a class="headerlink" href="#tags" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Tagging tasks and flows for organisation and filtering.</p>
<p><strong>Airflow equivalent:</strong> DAG/task tags for filtering in the UI.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect</span><span class="w"> </span><span class="kn">import</span> <span class="n">flow</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">task</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="nd">@task</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;etl&quot;</span><span class="p">,</span> <span class="s2">&quot;extract&quot;</span><span class="p">])</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_sales</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span> <span class="o">...</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;core_tags&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;examples&quot;</span><span class="p">,</span> <span class="s2">&quot;phase-2&quot;</span><span class="p">])</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">tags_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>    <span class="n">extract_sales</span><span class="p">()</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>    <span class="k">with</span> <span class="n">tags</span><span class="p">(</span><span class="s2">&quot;ad-hoc&quot;</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">):</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>        <span class="n">generic_task</span><span class="p">(</span><span class="s2">&quot;debug-data&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Static tags are set on decorators. The <code>tags()</code> context manager adds runtime
tags to all tasks within its scope. Tags are visible in the Prefect UI and can
be used for filtering and automation rules.</p>
<hr />
<h3 id="flow-run-names">Flow Run Names<a class="headerlink" href="#flow-run-names" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Custom flow run naming using templates and callables.</p>
<p><strong>Airflow equivalent:</strong> Custom DAG <code>run_id</code> / <code>dag_run</code> naming.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">flow_run_name</span><span class="o">=</span><span class="s2">&quot;report-</span><span class="si">{env}</span><span class="s2">-</span><span class="si">{date_str}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">template_named_flow</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_flow_name</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>    <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;dynamic-</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">flow_run_name</span><span class="o">=</span><span class="n">generate_flow_name</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">callable_named_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<p>Works like task run names but on <code>@flow</code>. Template strings and callables are
both supported.</p>
<hr />
<h3 id="result-persistence">Result Persistence<a class="headerlink" href="#result-persistence" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Persisting task and flow results for durability.</p>
<p><strong>Airflow equivalent:</strong> XCom backend configuration, custom result backends.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">persist_result</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="nd">@task</span><span class="p">(</span><span class="n">persist_result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">result_storage_key</span><span class="o">=</span><span class="s2">&quot;latest-summary-</span><span class="si">{parameters[label]}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_summary</span><span class="p">(</span><span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">] Total: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p><code>persist_result=True</code> stores results beyond the flow run lifetime.
<code>result_storage_key</code> provides a stable key for retrieval. Persistence behaviour
requires a Prefect server; tests verify logic only.</p>
<hr />
<h2 id="artifacts-and-blocks">Artifacts and Blocks<a class="headerlink" href="#artifacts-and-blocks" title="Permanent link">&para;</a></h2>
<h3 id="markdown-artifacts">Markdown Artifacts<a class="headerlink" href="#markdown-artifacts" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Creating markdown artifacts for rich reporting.</p>
<p><strong>Airflow equivalent:</strong> Custom HTML in XCom or external reporting tools.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect.artifacts</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_markdown_artifact</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="nd">@task</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">publish_report</span><span class="p">(</span><span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>    <span class="n">markdown</span> <span class="o">=</span> <span class="s2">&quot;# Report</span><span class="se">\n</span><span class="s2">| Name | Score |</span><span class="se">\n</span><span class="s2">|---|---|</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>    <span class="n">markdown</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> |&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    <span class="n">create_markdown_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;report&quot;</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="n">markdown</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Weekly report&quot;</span><span class="p">)</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    <span class="k">return</span> <span class="n">markdown</span>
</code></pre></div>
<p><code>create_markdown_artifact()</code> publishes formatted content visible in the Prefect
UI. Without a server, it silently no-ops â€” tests pass locally.</p>
<hr />
<h3 id="table-and-link-artifacts">Table and Link Artifacts<a class="headerlink" href="#table-and-link-artifacts" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Table and link artifacts for structured data display.</p>
<p><strong>Airflow equivalent:</strong> Custom UI plugins, external dashboards.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect.artifacts</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_link_artifact</span><span class="p">,</span> <span class="n">create_table_artifact</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="nd">@task</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">publish_table</span><span class="p">(</span><span class="n">inventory</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="n">create_table_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;inventory&quot;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">inventory</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Inventory levels&quot;</span><span class="p">)</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="nd">@task</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">publish_links</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>    <span class="n">create_link_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dashboard&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="s2">&quot;https://example.com/dashboard&quot;</span><span class="p">,</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>                         <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Live dashboard&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Table artifacts render as formatted tables. Link artifacts provide quick access
to related resources from the flow run page.</p>
<hr />
<h3 id="secret-block">Secret Block<a class="headerlink" href="#secret-block" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Secure credential management with Prefect's Secret block.</p>
<p><strong>Airflow equivalent:</strong> Connections / Variables with <code>is_encrypted</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect.blocks.system</span><span class="w"> </span><span class="kn">import</span> <span class="n">Secret</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="nd">@task</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_api_key</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>        <span class="n">secret</span> <span class="o">=</span> <span class="n">Secret</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;example-api-key&quot;</span><span class="p">)</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>        <span class="k">return</span> <span class="n">secret</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>        <span class="k">return</span> <span class="s2">&quot;dev-fallback-key-12345&quot;</span>
</code></pre></div>
<p><code>Secret.load()</code> retrieves encrypted values from the Prefect server. The fallback
pattern ensures local development works without a configured server.</p>
<hr />
<h3 id="custom-blocks">Custom Blocks<a class="headerlink" href="#custom-blocks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Defining custom Block classes for typed configuration.</p>
<p><strong>Airflow equivalent:</strong> Custom connection types, configuration classes.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect.blocks.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Block</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">DatabaseConfig</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>    <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mydb&quot;</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="nd">@task</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">connect_database</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">DatabaseConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Connected to </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">database</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p>Custom blocks provide typed, validated configuration. In production, save with
<code>block.save("name")</code> and load with <code>Block.load("name")</code>. Here blocks are
constructed directly for local testability.</p>
<hr />
<h2 id="async-patterns">Async Patterns<a class="headerlink" href="#async-patterns" title="Permanent link">&para;</a></h2>
<h3 id="async-tasks">Async Tasks<a class="headerlink" href="#async-tasks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Async task and flow definitions with sequential awaiting.</p>
<p><strong>Airflow equivalent:</strong> Deferrable operators (async sensor pattern).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nd">@task</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_fetch</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;core_async_tasks&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_tasks_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">async_fetch</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">)</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>    <span class="k">await</span> <span class="n">async_process</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>
<p>Async tasks and flows are defined with <code>async def</code> and awaited. The <code>__main__</code>
block uses <code>asyncio.run()</code>.</p>
<hr />
<h3 id="concurrent-async">Concurrent Async<a class="headerlink" href="#concurrent-async" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Concurrent task execution with <code>asyncio.gather()</code>.</p>
<p><strong>Airflow equivalent:</strong> Multiple deferrable operators running in parallel.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;core_concurrent_async&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">concurrent_async_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>    <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>        <span class="n">fetch_endpoint</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>        <span class="n">fetch_endpoint</span><span class="p">(</span><span class="s2">&quot;orders&quot;</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>        <span class="n">fetch_endpoint</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.2</span><span class="p">),</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>    <span class="p">)</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>    <span class="k">await</span> <span class="n">aggregate_results</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
</code></pre></div>
<p><code>asyncio.gather()</code> runs all fetches concurrently. Total wall-clock time is
approximately <code>max(delays)</code>, not <code>sum(delays)</code>.</p>
<hr />
<h3 id="async-flow-patterns">Async Flow Patterns<a class="headerlink" href="#async-flow-patterns" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Mixing sync and async tasks in an async flow.</p>
<p><strong>Airflow equivalent:</strong> Mix of standard and deferrable operators.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;core_async_flow_patterns&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_flow_patterns_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="n">sync_extract</span><span class="p">()</span>              <span class="c1"># sync task</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>    <span class="n">enriched</span> <span class="o">=</span> <span class="k">await</span> <span class="n">enrich_subflow</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>  <span class="c1"># async subflow with gather</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>    <span class="n">sync_load</span><span class="p">(</span><span class="n">enriched</span><span class="p">)</span>               <span class="c1"># sync task</span>
</code></pre></div>
<p>Sync tasks are called normally inside async flows. Async subflows use
<code>asyncio.gather()</code> for concurrent fan-out over records.</p>
<hr />
<h3 id="async-map-and-submit">Async Map and Submit<a class="headerlink" href="#async-map-and-submit" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> <code>.map()</code> and <code>.submit()</code> with async tasks.</p>
<p><strong>Airflow equivalent:</strong> Dynamic task mapping with deferrable operators.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;core_async_map_and_submit&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_map_and_submit_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>    <span class="n">transform_futures</span> <span class="o">=</span> <span class="n">async_transform</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>    <span class="n">transformed</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">transform_futures</span><span class="p">]</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>    <span class="n">validate_futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">async_validate</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">transformed</span><span class="p">]</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>    <span class="n">validations</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">validate_futures</span><span class="p">]</span>
</code></pre></div>
<p><code>.map()</code> and <code>.submit()</code> work with async tasks for parallel fan-out within
an async flow.</p>
<hr />
<h2 id="deployment-and-scheduling">Deployment and Scheduling<a class="headerlink" href="#deployment-and-scheduling" title="Permanent link">&para;</a></h2>
<h3 id="flow-serve">Flow Serve<a class="headerlink" href="#flow-serve" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> The simplest deployment method: <code>flow.serve()</code>.</p>
<p><strong>Airflow equivalent:</strong> DAG placed in <code>dags/</code> folder, picked up by scheduler.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;core_flow_serve&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">flow_serve_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">()</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    <span class="n">transformed</span> <span class="o">=</span> <span class="n">transform_data</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    <span class="n">load_data</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="c1"># Deploy with: flow_serve_flow.serve(name=&quot;037-flow-serve&quot;, cron=&quot;*/5 * * * *&quot;)</span>
</code></pre></div>
<p><code>flow.serve()</code> creates a lightweight deployment that runs locally. Pass <code>cron=</code>
or <code>interval=</code> for scheduling. For production infrastructure isolation, use
<code>flow.deploy()</code> with work pools.</p>
<hr />
<h3 id="schedules">Schedules<a class="headerlink" href="#schedules" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Schedule types for Prefect deployments.</p>
<p><strong>Airflow equivalent:</strong> DAG <code>schedule_interval</code> (cron, timedelta, timetable).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1"># CronSchedule: daily_report_flow.serve(name=&quot;daily&quot;, cron=&quot;0 6 * * *&quot;)</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="c1"># IntervalSchedule: interval_check_flow.serve(name=&quot;interval&quot;, interval=900)</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="c1"># RRuleSchedule: custom_flow.serve(name=&quot;custom&quot;, rrule=&quot;FREQ=WEEKLY;BYDAY=MO,WE,FR&quot;)</span>
</code></pre></div>
<p>Three schedule types: <code>CronSchedule</code> for cron expressions, <code>IntervalSchedule</code>
for fixed intervals, and <code>RRuleSchedule</code> for complex recurrence rules. All can
be passed to <code>flow.serve(schedule=...)</code> or <code>flow.deploy(schedule=...)</code>.</p>
<hr />
<h3 id="work-pools">Work Pools<a class="headerlink" href="#work-pools" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Work pool concepts for production deployments.</p>
<p><strong>Airflow equivalent:</strong> Executors (Local, Celery, Kubernetes).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># Deploy to a work pool:</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="c1"># work_pools_flow.deploy(name=&quot;039-work-pool&quot;, work_pool_name=&quot;my-pool&quot;)</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="c1"># Start a worker:</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="c1"># prefect worker start --pool &quot;my-pool&quot;</span>
</code></pre></div>
<p>Work pools define WHERE work runs. Types include <code>process</code>, <code>docker</code>, and
<code>kubernetes</code>. <code>flow.deploy()</code> targets a named pool. Workers are long-running
processes that poll a work pool for scheduled runs.</p>
<hr />
<h3 id="production-pipeline">Production Pipeline<a class="headerlink" href="#production-pipeline" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Capstone flow combining all Phase 2 concepts.</p>
<p><strong>Airflow equivalent:</strong> Production DAG with sensors, retries, SLAs, callbacks.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;core_production_pipeline&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">production_pipeline</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>    <span class="k">with</span> <span class="n">tags</span><span class="p">(</span><span class="s2">&quot;production&quot;</span><span class="p">,</span> <span class="s2">&quot;phase-2&quot;</span><span class="p">):</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="n">extract_stage</span><span class="p">()</span>           <span class="c1"># tagged subflow</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>        <span class="n">transformed</span> <span class="o">=</span> <span class="n">transform_stage</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>  <span class="c1"># retries + caching</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>        <span class="n">summary</span> <span class="o">=</span> <span class="n">load_stage</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>   <span class="c1"># persist_result</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>        <span class="n">notify</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>                     <span class="c1"># markdown artifact</span>
</code></pre></div>
<p>This is the capstone flow for Phase 2, combining task caching (<code>INPUTS</code> policy),
retries, markdown artifacts, tags, result persistence, and structured logging
into a production-ready pipeline.</p>
<hr />
<h2 id="pydantic-and-data-patterns">Pydantic and Data Patterns<a class="headerlink" href="#pydantic-and-data-patterns" title="Permanent link">&para;</a></h2>
<h3 id="pydantic-models">Pydantic Models<a class="headerlink" href="#pydantic-models" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Using Pydantic <code>BaseModel</code> as task parameters and return types for automatic validation and type safety.</p>
<p><strong>Airflow equivalent:</strong> XCom push/pull with complex types (JSON/pickle serialisation).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserRecord</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="nd">@task</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_users</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">PipelineConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">UserRecord</span><span class="p">]:</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}]</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">UserRecord</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">[:</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]]</span>
</code></pre></div>
<p>Pydantic models flow naturally between tasks -- no XCom serialisation pain. Validation happens automatically on construction.</p>
<hr />
<h3 id="shell-tasks">Shell Tasks<a class="headerlink" href="#shell-tasks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Running shell commands and scripts from Prefect tasks using <code>subprocess</code>.</p>
<p><strong>Airflow equivalent:</strong> BashOperator.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="nd">@task</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div>
<p>Prefect has no BashOperator. <code>subprocess.run()</code> inside a <code>@task</code> is the direct equivalent.</p>
<hr />
<h3 id="http-tasks">HTTP Tasks<a class="headerlink" href="#http-tasks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Making HTTP requests from tasks using <code>httpx</code>.</p>
<p><strong>Airflow equivalent:</strong> HttpOperator, HttpSensor.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="nd">@task</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>
<p>No special operator needed. <code>httpx</code> (a Prefect transitive dependency) in a <code>@task</code> replaces HttpOperator entirely.</p>
<hr />
<h3 id="task-factories">Task Factories<a class="headerlink" href="#task-factories" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Creating reusable tasks dynamically with factory functions.</p>
<p><strong>Airflow equivalent:</strong> Custom operators, <code>@task.bash</code> decorator variants.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_extractor</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>    <span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;extract_</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">extract</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s2">&quot;records&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">]}</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>    <span class="k">return</span> <span class="n">extract</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="n">extract_api</span> <span class="o">=</span> <span class="n">make_extractor</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="n">extract_database</span> <span class="o">=</span> <span class="n">make_extractor</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Factory functions generate <code>@task</code>-decorated callables for consistent behaviour across different data sources.</p>
<hr />
<h2 id="advanced-mapping-and-error-handling">Advanced Mapping and Error Handling<a class="headerlink" href="#advanced-mapping-and-error-handling" title="Permanent link">&para;</a></h2>
<h3 id="advanced-map-patterns">Advanced Map Patterns<a class="headerlink" href="#advanced-map-patterns" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Multi-argument <code>.map()</code>, chained maps, and result collection.</p>
<p><strong>Airflow equivalent:</strong> <code>expand_kwargs()</code>, <code>partial().expand()</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">station_futures</span> <span class="o">=</span> <span class="n">process_station</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>    <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;station_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">],</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>    <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">],</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>    <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">],</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="p">)</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="n">station_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">station_futures</span><span class="p">]</span>
</code></pre></div>
<p>Unpack list-of-dicts into parallel <code>.map()</code> calls by passing separate lists for each parameter.</p>
<hr />
<h3 id="error-handling-etl">Error Handling ETL<a class="headerlink" href="#error-handling-etl" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> The quarantine pattern -- good rows pass through, bad rows are captured with error reasons.</p>
<p><strong>Airflow equivalent:</strong> Error handling with quarantine pattern.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">QuarantineResult</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>    <span class="n">good_records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="n">bad_records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>    <span class="n">errors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="nd">@task</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_with_quarantine</span><span class="p">(</span><span class="n">records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">QuarantineResult</span><span class="p">:</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>    <span class="n">good</span><span class="p">,</span> <span class="n">bad</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>            <span class="n">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>            <span class="n">good</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>            <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a>    <span class="k">return</span> <span class="n">QuarantineResult</span><span class="p">(</span><span class="n">good_records</span><span class="o">=</span><span class="n">good</span><span class="p">,</span> <span class="n">bad_records</span><span class="o">=</span><span class="n">bad</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
</code></pre></div>
<p>Pydantic models make quarantine results structured and type-safe.</p>
<hr />
<h3 id="pydantic-validation">Pydantic Validation<a class="headerlink" href="#pydantic-validation" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Using Pydantic <code>field_validator</code> for data quality enforcement.</p>
<p><strong>Airflow equivalent:</strong> Schema validation pipeline.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">WeatherReading</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>    <span class="n">station_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>    <span class="n">humidity</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">)</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">temperature_in_range</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">100</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temperature </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> out of range&quot;</span><span class="p">)</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>        <span class="k">return</span> <span class="n">v</span>
</code></pre></div>
<p><code>field_validator</code> replaces manual schema checking code. Invalid data raises a <code>ValidationError</code> automatically.</p>
<hr />
<h3 id="sla-monitoring">SLA Monitoring<a class="headerlink" href="#sla-monitoring" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Tracking task durations and comparing against SLA thresholds.</p>
<p><strong>Airflow equivalent:</strong> SLA miss detection, <code>execution_timeout</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="nd">@task</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">sla_report</span><span class="p">(</span><span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">thresholds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>        <span class="n">limit</span> <span class="o">=</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="n">duration</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="k">else</span> <span class="s2">&quot;BREACH&quot;</span>
</code></pre></div>
<p>Use <code>time.monotonic()</code> for accurate timing and compare against configurable thresholds.</p>
<hr />
<h2 id="notifications-and-observability">Notifications and Observability<a class="headerlink" href="#notifications-and-observability" title="Permanent link">&para;</a></h2>
<h3 id="webhook-notifications">Webhook Notifications<a class="headerlink" href="#webhook-notifications" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Sending webhook notifications on pipeline events.</p>
<p><strong>Airflow equivalent:</strong> Webhook alerts on pipeline events.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="nd">@flow</span><span class="p">(</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;patterns_webhook_notifications&quot;</span><span class="p">,</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="n">on_completion</span><span class="o">=</span><span class="p">[</span><span class="n">on_flow_completion</span><span class="p">],</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="n">on_failure</span><span class="o">=</span><span class="p">[</span><span class="n">on_flow_failure</span><span class="p">],</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="p">)</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">webhook_notifications_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>    <span class="n">send_notification</span><span class="p">(</span><span class="s2">&quot;pipeline.started&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;demo&quot;</span><span class="p">})</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">()</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>    <span class="n">send_notification</span><span class="p">(</span><span class="s2">&quot;pipeline.completed&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p>Flow hooks (<code>on_completion</code>, <code>on_failure</code>) trigger automatically. In production, <code>send_notification</code> would POST to Slack, PagerDuty, etc.</p>
<hr />
<h3 id="notification-blocks">Notification Blocks<a class="headerlink" href="#notification-blocks" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Using Prefect's built-in <code>SlackWebhook</code> and
<code>CustomWebhookNotificationBlock</code> for pipeline alerting with a unified
<code>notify(body, subject)</code> interface.</p>
<p><strong>Airflow equivalent:</strong> Slack/email/PagerDuty callbacks via operators.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="nd">@task</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure_notification_blocks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>    <span class="n">slack</span> <span class="o">=</span> <span class="n">SlackWebhook</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">SecretStr</span><span class="p">(</span><span class="s2">&quot;https://hooks.slack.com/services/T00/B00/xxxx&quot;</span><span class="p">))</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>    <span class="n">custom</span> <span class="o">=</span> <span class="n">CustomWebhookNotificationBlock</span><span class="p">(</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ops-webhook&quot;</span><span class="p">,</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://monitoring.example.com/alerts&quot;</span><span class="p">,</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>        <span class="n">json_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;{{subject}}: {{body}}&quot;</span><span class="p">},</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>        <span class="n">secrets</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;api_token&quot;</span><span class="p">:</span> <span class="s2">&quot;placeholder-token&quot;</span><span class="p">},</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>    <span class="p">)</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;slack&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">slack</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">custom</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="nd">@task</span>
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_template_resolution</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a>    <span class="n">block</span> <span class="o">=</span> <span class="n">CustomWebhookNotificationBlock</span><span class="p">(</span>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;template-demo&quot;</span><span class="p">,</span>
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a>        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://api.example.com/notify?token={{api_token}}&quot;</span><span class="p">,</span>
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a>        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a>        <span class="n">json_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a>            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;{{subject}}&quot;</span><span class="p">,</span>
<a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a>            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;{{body}}&quot;</span><span class="p">,</span>
<a id="__codelineno-50-23" name="__codelineno-50-23" href="#__codelineno-50-23"></a>            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;{{name}}&quot;</span><span class="p">,</span>
<a id="__codelineno-50-24" name="__codelineno-50-24" href="#__codelineno-50-24"></a>            <span class="s2">&quot;auth&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer {{api_token}}&quot;</span><span class="p">,</span>
<a id="__codelineno-50-25" name="__codelineno-50-25" href="#__codelineno-50-25"></a>        <span class="p">},</span>
<a id="__codelineno-50-26" name="__codelineno-50-26" href="#__codelineno-50-26"></a>        <span class="n">secrets</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;api_token&quot;</span><span class="p">:</span> <span class="s2">&quot;secret-xyz-789&quot;</span><span class="p">},</span>
<a id="__codelineno-50-27" name="__codelineno-50-27" href="#__codelineno-50-27"></a>    <span class="p">)</span>
<a id="__codelineno-50-28" name="__codelineno-50-28" href="#__codelineno-50-28"></a>    <span class="k">return</span> <span class="n">block</span><span class="o">.</span><span class="n">_build_request_args</span><span class="p">(</span>
<a id="__codelineno-50-29" name="__codelineno-50-29" href="#__codelineno-50-29"></a>        <span class="n">body</span><span class="o">=</span><span class="s2">&quot;Pipeline completed: 150 records processed&quot;</span><span class="p">,</span>
<a id="__codelineno-50-30" name="__codelineno-50-30" href="#__codelineno-50-30"></a>        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Pipeline Alert&quot;</span><span class="p">,</span>
<a id="__codelineno-50-31" name="__codelineno-50-31" href="#__codelineno-50-31"></a>    <span class="p">)</span>
<a id="__codelineno-50-32" name="__codelineno-50-32" href="#__codelineno-50-32"></a>
<a id="__codelineno-50-33" name="__codelineno-50-33" href="#__codelineno-50-33"></a><span class="k">def</span><span class="w"> </span><span class="nf">on_completion_notify</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">flow_run</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<a id="__codelineno-50-34" name="__codelineno-50-34" href="#__codelineno-50-34"></a>    <span class="c1"># SlackWebhook.load(&quot;prod-slack&quot;).notify(</span>
<a id="__codelineno-50-35" name="__codelineno-50-35" href="#__codelineno-50-35"></a>    <span class="c1">#     body=f&quot;Flow {flow_run.name!r} completed.&quot;, subject=&quot;Flow Completed&quot;)</span>
<a id="__codelineno-50-36" name="__codelineno-50-36" href="#__codelineno-50-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HOOK  Flow </span><span class="si">{</span><span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> completed -- would notify via SlackWebhook&quot;</span><span class="p">)</span>
<a id="__codelineno-50-37" name="__codelineno-50-37" href="#__codelineno-50-37"></a>
<a id="__codelineno-50-38" name="__codelineno-50-38" href="#__codelineno-50-38"></a><span class="nd">@flow</span><span class="p">(</span>
<a id="__codelineno-50-39" name="__codelineno-50-39" href="#__codelineno-50-39"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;patterns_notification_blocks&quot;</span><span class="p">,</span>
<a id="__codelineno-50-40" name="__codelineno-50-40" href="#__codelineno-50-40"></a>    <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-50-41" name="__codelineno-50-41" href="#__codelineno-50-41"></a>    <span class="n">on_completion</span><span class="o">=</span><span class="p">[</span><span class="n">on_completion_notify</span><span class="p">],</span>
<a id="__codelineno-50-42" name="__codelineno-50-42" href="#__codelineno-50-42"></a>    <span class="n">on_failure</span><span class="o">=</span><span class="p">[</span><span class="n">on_failure_notify</span><span class="p">],</span>
<a id="__codelineno-50-43" name="__codelineno-50-43" href="#__codelineno-50-43"></a><span class="p">)</span>
<a id="__codelineno-50-44" name="__codelineno-50-44" href="#__codelineno-50-44"></a><span class="k">def</span><span class="w"> </span><span class="nf">notification_blocks_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-50-45" name="__codelineno-50-45" href="#__codelineno-50-45"></a>    <span class="n">channels</span> <span class="o">=</span> <span class="n">configure_notification_blocks</span><span class="p">()</span>
<a id="__codelineno-50-46" name="__codelineno-50-46" href="#__codelineno-50-46"></a>    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">]:</span>
<a id="__codelineno-50-47" name="__codelineno-50-47" href="#__codelineno-50-47"></a>        <span class="n">process_data</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<a id="__codelineno-50-48" name="__codelineno-50-48" href="#__codelineno-50-48"></a>    <span class="n">demonstrate_template_resolution</span><span class="p">()</span>
</code></pre></div>
<p>All notification blocks share the same <code>notify(body, subject)</code> method.
<code>SlackWebhook</code> sends to a Slack webhook URL; <code>CustomWebhookNotificationBlock</code>
sends to any HTTP endpoint with template resolution for <code>{{subject}}</code>,
<code>{{body}}</code>, <code>{{name}}</code>, and custom <code>secrets</code> keys. Flow hooks wire these
blocks to lifecycle events for automatic alerting in production.</p>
<hr />
<h3 id="webhook-block">Webhook Block<a class="headerlink" href="#webhook-block" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Using the built-in <code>Webhook</code> block for configurable
outbound HTTP calls with stored credentials.</p>
<p><strong>Airflow equivalent:</strong> <code>SimpleHttpOperator</code> with connection credentials.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="nd">@task</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_post_webhook</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>    <span class="n">webhook</span> <span class="o">=</span> <span class="n">Webhook</span><span class="p">(</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>        <span class="n">url</span><span class="o">=</span><span class="n">SecretStr</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/events&quot;</span><span class="p">),</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>        <span class="n">headers</span><span class="o">=</span><span class="n">SecretDict</span><span class="p">({</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer placeholder-token&quot;</span><span class="p">,</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>        <span class="p">}),</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>    <span class="p">)</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>    <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">webhook</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>        <span class="s2">&quot;url_host&quot;</span><span class="p">:</span> <span class="s2">&quot;api.example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>        <span class="s2">&quot;header_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">webhook</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get_secret_value</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>    <span class="p">}</span>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;POST webhook configured: </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>    <span class="k">return</span> <span class="n">summary</span>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="nd">@task</span>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">simulate_webhook_call</span><span class="p">(</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">url_host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a>        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a>        <span class="s2">&quot;url_host&quot;</span><span class="p">:</span> <span class="n">url_host</span><span class="p">,</span>
<a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a>        <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
<a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a>        <span class="s2">&quot;simulated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a>    <span class="p">}</span>
<a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulated </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">url_host</span><span class="si">}</span><span class="s2"> -- payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a>    <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a>
<a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;core_webhook_block&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a><span class="k">def</span><span class="w"> </span><span class="nf">webhook_block_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a>    <span class="n">post_summary</span> <span class="o">=</span> <span class="n">create_post_webhook</span><span class="p">()</span>
<a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a>    <span class="n">post_result</span> <span class="o">=</span> <span class="n">simulate_webhook_call</span><span class="p">(</span>
<a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a>        <span class="n">method</span><span class="o">=</span><span class="n">post_summary</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">],</span>
<a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a>        <span class="n">url_host</span><span class="o">=</span><span class="n">post_summary</span><span class="p">[</span><span class="s2">&quot;url_host&quot;</span><span class="p">],</span>
<a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a>        <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;pipeline.completed&quot;</span><span class="p">,</span> <span class="s2">&quot;records&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">},</span>
<a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a>    <span class="p">)</span>
<a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a>    <span class="n">pattern</span> <span class="o">=</span> <span class="n">demonstrate_save_load_pattern</span><span class="p">()</span>
<a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;post_result&quot;</span><span class="p">:</span> <span class="n">post_result</span><span class="p">,</span> <span class="s2">&quot;persistence_pattern&quot;</span><span class="p">:</span> <span class="n">pattern</span><span class="p">}</span>
</code></pre></div>
<p>The <code>Webhook</code> block stores URL, method, headers, and auth in a reusable,
server-persisted block. It powers the <code>CallWebhook</code> automation action and can
replace ad-hoc <code>httpx.post()</code> calls with a managed, auditable configuration.</p>
<hr />
<h3 id="failure-escalation">Failure Escalation<a class="headerlink" href="#failure-escalation" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Progressive retry with escalation hooks at each failure.</p>
<p><strong>Airflow equivalent:</strong> Progressive retry with escalating callbacks.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">on_failure</span><span class="o">=</span><span class="p">[</span><span class="n">on_task_failure</span><span class="p">])</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">flaky_task</span><span class="p">(</span><span class="n">fail_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>    <span class="o">...</span>
</code></pre></div>
<p>The <code>on_failure</code> hook fires on each retry failure, allowing escalation logging. After all retries exhaust, the flow-level <code>on_completion</code> hook reports the final outcome.</p>
<hr />
<h3 id="testable-flow-patterns">Testable Flow Patterns<a class="headerlink" href="#testable-flow-patterns" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Separating business logic from Prefect wiring for maximum testability.</p>
<p><strong>Airflow equivalent:</strong> Thin DAG wiring with logic in external modules.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1"># Pure function (no Prefect imports)</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">_validate_record</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;missing name&quot;</span><span class="p">)</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>    <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="c1"># Thin task wrapper</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="nd">@task</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>    <span class="k">return</span> <span class="n">_validate_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</code></pre></div>
<p>Test pure functions directly (fast, no Prefect overhead) and task wrappers via <code>.fn()</code>.</p>
<hr />
<h3 id="reusable-utilities">Reusable Utilities<a class="headerlink" href="#reusable-utilities" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Custom task utility decorators for consistent behaviour.</p>
<p><strong>Airflow equivalent:</strong> Custom hooks and sensors.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">timed_task</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>    <span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;_duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>    <span class="k">return</span> <span class="n">wrapper</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="nd">@timed_task</span>
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_metric</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;ops/sec&quot;</span><span class="p">}</span>
</code></pre></div>
<p>Build a task utility library for timing, validation, and other cross-cutting concerns.</p>
<hr />
<h2 id="composition-and-scheduling">Composition and Scheduling<a class="headerlink" href="#composition-and-scheduling" title="Permanent link">&para;</a></h2>
<h3 id="advanced-state-handling">Advanced State Handling<a class="headerlink" href="#advanced-state-handling" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Using <code>allow_failure</code> and state inspection for mixed-outcome workflows.</p>
<p><strong>Airflow equivalent:</strong> Trigger rules (<code>all_success</code>, <code>all_done</code>, etc.).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect</span><span class="w"> </span><span class="kn">import</span> <span class="n">allow_failure</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="n">fail_future</span> <span class="o">=</span> <span class="n">fail_task</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="n">skip_task</span><span class="p">(</span><span class="n">wait_for</span><span class="o">=</span><span class="p">[</span><span class="n">allow_failure</span><span class="p">(</span><span class="n">fail_future</span><span class="p">)])</span>
</code></pre></div>
<p><code>allow_failure</code> lets downstream tasks run even when upstream tasks fail. Combine with state inspection for conditional logic.</p>
<hr />
<h3 id="nested-subflows">Nested Subflows<a class="headerlink" href="#nested-subflows" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Organising complex pipelines with hierarchical subflow groups.</p>
<p><strong>Airflow equivalent:</strong> TaskGroups and nested groups.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;patterns_nested_subflows&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">nested_subflows_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="n">extract_group</span><span class="p">()</span>       <span class="c1"># subflow with multiple tasks</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>    <span class="n">transformed</span> <span class="o">=</span> <span class="n">transform_group</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>  <span class="c1"># subflow with clean + enrich</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>    <span class="n">load_group</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>     <span class="c1"># subflow with write + verify</span>
</code></pre></div>
<p>Each subflow appears as a nested flow run in the Prefect UI with independent state tracking -- the equivalent of Airflow TaskGroups.</p>
<hr />
<h3 id="backfill-patterns">Backfill Patterns<a class="headerlink" href="#backfill-patterns" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Parameterised pipelines for date-range processing with gap detection.</p>
<p><strong>Airflow equivalent:</strong> Backfill awareness, parameterised pipelines.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;patterns_backfill_patterns&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">backfill_patterns_flow</span><span class="p">(</span><span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2024-01-01&quot;</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2024-01-05&quot;</span><span class="p">):</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>    <span class="n">initial_results</span> <span class="o">=</span> <span class="n">process_date</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">initial_dates</span><span class="p">)</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>    <span class="n">gaps</span> <span class="o">=</span> <span class="n">detect_gaps</span><span class="p">(</span><span class="n">initial_dates</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>    <span class="n">backfill_results</span> <span class="o">=</span> <span class="n">process_date</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span>
</code></pre></div>
<p>Flow parameters replace Airflow's <code>logical_date</code>. Gap detection identifies missing dates for incremental backfill.</p>
<hr />
<h3 id="runtime-context">Runtime Context<a class="headerlink" href="#runtime-context" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Accessing flow and task run metadata at runtime.</p>
<p><strong>Airflow equivalent:</strong> Jinja templating (<code>{{ ds }}</code>), macros, runtime info.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect.runtime</span><span class="w"> </span><span class="kn">import</span> <span class="n">flow_run</span><span class="p">,</span> <span class="n">task_run</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="nd">@task</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_flow_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>        <span class="s2">&quot;flow_run_name&quot;</span><span class="p">:</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>        <span class="s2">&quot;flow_name&quot;</span><span class="p">:</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">flow_name</span><span class="p">,</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>    <span class="p">}</span>
</code></pre></div>
<p><code>prefect.runtime</code> provides access to flow run ID, name, parameters, and tags -- replacing Airflow's Jinja template variables.</p>
<hr />
<h2 id="advanced-features-and-capstone">Advanced Features and Capstone<a class="headerlink" href="#advanced-features-and-capstone" title="Permanent link">&para;</a></h2>
<h3 id="transactions">Transactions<a class="headerlink" href="#transactions" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Atomic task groups with rollback on failure using Prefect transactions.</p>
<p><strong>Airflow equivalent:</strong> No direct equivalent -- Prefect-specific feature.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect.transactions</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;patterns_transactions&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">transactions_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>    <span class="k">with</span> <span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">step_a</span><span class="p">()</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">step_b</span><span class="p">()</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">step_c</span><span class="p">()</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>    <span class="n">summarize_transaction</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
</code></pre></div>
<p>The <code>transaction()</code> context manager groups tasks atomically. This is a unique Prefect advantage with no Airflow equivalent.</p>
<hr />
<h3 id="interactive-flows">Interactive Flows<a class="headerlink" href="#interactive-flows" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Human-in-the-loop approval patterns.</p>
<p><strong>Airflow equivalent:</strong> Human-in-the-loop operators.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;patterns_interactive_flows&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">interactive_flows_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">prepare_data</span><span class="p">()</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>    <span class="n">approved</span> <span class="o">=</span> <span class="n">mock_approval</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># In production: pause_flow_run()</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>    <span class="k">if</span> <span class="n">approved</span><span class="p">:</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>        <span class="n">publish</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>        <span class="n">archive</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<p>In production, use <code>pause_flow_run()</code> to pause and wait for human input via the Prefect UI. The mock approval pattern enables local testing.</p>
<hr />
<h3 id="task-runners">Task Runners<a class="headerlink" href="#task-runners" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Comparing thread pool and default task runners for different workloads.</p>
<p><strong>Airflow equivalent:</strong> Executors (Local, Celery, Kubernetes).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prefect.task_runners</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolTaskRunner</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">task_runner</span><span class="o">=</span><span class="n">ThreadPoolTaskRunner</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">threaded_io_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="n">io_bound_task</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>    <span class="k">return</span> <span class="n">summarize_runner</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">],</span> <span class="s2">&quot;ThreadPool&quot;</span><span class="p">)</span>
</code></pre></div>
<p><code>ThreadPoolTaskRunner</code> provides concurrent execution for I/O-bound tasks. The default runner handles CPU-bound work.</p>
<hr />
<h3 id="production-pipeline-v2">Production Pipeline v2<a class="headerlink" href="#production-pipeline-v2" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Capstone flow combining all Phase 3 features into a production-ready pipeline.</p>
<p><strong>Airflow equivalent:</strong> Full ETL SCD capstone.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;patterns_production_pipeline_v2&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_completion</span><span class="o">=</span><span class="p">[</span><span class="n">on_pipeline_completion</span><span class="p">])</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">production_pipeline_v2_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>    <span class="k">with</span> <span class="n">tags</span><span class="p">(</span><span class="s2">&quot;production&quot;</span><span class="p">,</span> <span class="s2">&quot;phase-3&quot;</span><span class="p">):</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>        <span class="n">source_records</span> <span class="o">=</span> <span class="n">extract_stage</span><span class="p">()</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>        <span class="k">with</span> <span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>            <span class="n">validated</span> <span class="o">=</span> <span class="n">validate_stage</span><span class="p">(</span><span class="n">source_records</span><span class="p">)</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>        <span class="n">transformed</span> <span class="o">=</span> <span class="n">transform_stage</span><span class="p">(</span><span class="n">validated</span><span class="p">)</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>        <span class="n">publish_summary</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
</code></pre></div>
<p>This capstone combines Pydantic models with field validators, transactions, retries, markdown artifacts, tags, state hooks, and <code>.map()</code> into a realistic production pipeline.</p>
<hr />
<h2 id="file-io-patterns">File I/O Patterns<a class="headerlink" href="#file-io-patterns" title="Permanent link">&para;</a></h2>
<h3 id="csv-file-processing">CSV File Processing<a class="headerlink" href="#csv-file-processing" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> File-based ETL pipeline using the stdlib <code>csv</code> module
with generate, read, validate, transform, write, and archive steps.</p>
<p><strong>Airflow equivalent:</strong> CSV landing zone pipeline (DAG 063).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="nd">@task</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate_csv_row</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">row_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">required_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">CsvRecord</span><span class="p">:</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span><span class="p">:</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing or empty required column: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>    <span class="k">return</span> <span class="n">CsvRecord</span><span class="p">(</span><span class="n">row_number</span><span class="o">=</span><span class="n">row_number</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
</code></pre></div>
<p><code>csv.DictReader</code> and <code>csv.DictWriter</code> replace external CSV libraries.
<code>tempfile.mkdtemp()</code> provides isolated working directories.</p>
<hr />
<h3 id="json-event-ingestion">JSON Event Ingestion<a class="headerlink" href="#json-event-ingestion" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Recursive nested JSON flattening into dot-separated
keys with NDJSON (newline-delimited JSON) output.</p>
<p><strong>Airflow equivalent:</strong> JSON event stream to Parquet (DAG 064).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="nd">@task</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">flatten_dict</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>    <span class="n">items</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>        <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">separator</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="n">key</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>            <span class="n">items</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flatten_dict</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">separator</span><span class="p">))</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a>            <span class="n">items</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>    <span class="k">return</span> <span class="n">items</span>
</code></pre></div>
<p>Recursive flattening handles arbitrarily nested structures. NDJSON output
writes one JSON object per line for streaming consumption.</p>
<hr />
<h3 id="multi-file-batch-processing">Multi-File Batch Processing<a class="headerlink" href="#multi-file-batch-processing" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Mixed CSV+JSON batch processing with file-type
dispatch, column harmonisation, and hash-based deduplication.</p>
<p><strong>Airflow equivalent:</strong> Mixed CSV+JSON batch processing (DAG 065).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="nd">@task</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>    <span class="n">suffix</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>    <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>    <span class="k">elif</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
</code></pre></div>
<p>File suffix determines the reader. Column harmonisation maps different schemas
to a unified format. Hash dedup uses <code>hashlib.sha256</code> on key fields.</p>
<hr />
<h3 id="incremental-processing">Incremental Processing<a class="headerlink" href="#incremental-processing" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Manifest-based incremental file processing. A JSON
manifest tracks which files have been processed; re-runs skip them.</p>
<p><strong>Airflow equivalent:</strong> Manifest-based incremental file processing (DAG 067).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="nd">@task</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">identify_new_files</span><span class="p">(</span><span class="n">all_files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">manifest</span><span class="p">:</span> <span class="n">ProcessingManifest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">processed_files</span><span class="p">]</span>
</code></pre></div>
<p>Run the flow twice: the second run processes zero files because the manifest
already records them. This is the foundation for idempotent file pipelines.</p>
<hr />
<h2 id="data-quality-framework">Data Quality Framework<a class="headerlink" href="#data-quality-framework" title="Permanent link">&para;</a></h2>
<h3 id="quality-rules-engine">Quality Rules Engine<a class="headerlink" href="#quality-rules-engine" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Configuration-driven data quality rules with a
registry pattern and traffic-light scoring (green/amber/red).</p>
<p><strong>Airflow equivalent:</strong> Freshness and completeness checks (DAG 070).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="nd">@task</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute_rule</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">rule</span><span class="p">:</span> <span class="n">QualityRule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RuleResult</span><span class="p">:</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>    <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">rule_type</span> <span class="o">==</span> <span class="s2">&quot;not_null&quot;</span><span class="p">:</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>        <span class="k">return</span> <span class="n">run_not_null_check</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>    <span class="k">elif</span> <span class="n">rule</span><span class="o">.</span><span class="n">rule_type</span> <span class="o">==</span> <span class="s2">&quot;range&quot;</span><span class="p">:</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>        <span class="k">return</span> <span class="n">run_range_check</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<p>Rules are defined as config dicts, parsed into Pydantic models, and dispatched
to check functions. The overall score determines the traffic light.</p>
<hr />
<h3 id="cross-dataset-validation">Cross-Dataset Validation<a class="headerlink" href="#cross-dataset-validation" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Referential integrity checks between related datasets
(orders, customers, products) with orphan detection.</p>
<p><strong>Airflow equivalent:</strong> Referential integrity checks (DAG 071).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="nd">@task</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_referential_integrity</span><span class="p">(</span><span class="n">child_data</span><span class="p">,</span> <span class="n">parent_data</span><span class="p">,</span> <span class="n">child_key</span><span class="p">,</span> <span class="n">parent_key</span><span class="p">,</span> <span class="n">check_name</span><span class="p">):</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>    <span class="n">parent_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="n">parent_key</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">parent_data</span><span class="p">}</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>    <span class="n">orphan_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">child_key</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">child_data</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">child_key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent_values</span><span class="p">]</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>    <span class="k">return</span> <span class="n">IntegrityResult</span><span class="p">(</span><span class="n">orphan_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">orphan_keys</span><span class="p">),</span> <span class="n">passed</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">orphan_keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<p>Foreign key validation is a pure Python set operation. The test data deliberately
includes orphan records to demonstrate detection.</p>
<hr />
<h3 id="data-profiling">Data Profiling<a class="headerlink" href="#data-profiling" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Statistical data profiling using the stdlib
<code>statistics</code> module (mean, stdev, median) with column-level type inference.</p>
<p><strong>Airflow equivalent:</strong> Consolidated quality dashboard (DAG 072).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="nd">@task</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">profile_numeric_column</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnProfile</span><span class="p">:</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>    <span class="n">non_null</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>    <span class="k">return</span> <span class="n">ColumnProfile</span><span class="p">(</span>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;numeric&quot;</span><span class="p">,</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>        <span class="n">mean</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">non_null</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>        <span class="n">stdev</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">non_null</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>        <span class="n">median</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">statistics</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">non_null</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span> <span class="o">...</span>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>    <span class="p">)</span>
</code></pre></div>
<p>Column type is inferred from values. Numeric columns get statistical profiles;
string columns get length and uniqueness counts.</p>
<hr />
<h3 id="pipeline-health-monitor">Pipeline Health Monitor<a class="headerlink" href="#pipeline-health-monitor" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Meta-monitoring / watchdog pattern. A flow checks
the health of other pipelines' outputs via file existence, freshness, row
counts, and value range checks.</p>
<p><strong>Airflow equivalent:</strong> Pipeline health check (DAG 076).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="nd">@task</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_health</span><span class="p">(</span><span class="n">pipeline_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HealthCheckResult</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">PipelineHealthReport</span><span class="p">:</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;critical&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>        <span class="n">overall</span> <span class="o">=</span> <span class="s2">&quot;critical&quot;</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;degraded&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>        <span class="n">overall</span> <span class="o">=</span> <span class="s2">&quot;degraded&quot;</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>        <span class="n">overall</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
</code></pre></div>
<p>Worst-status-wins aggregation ensures a single failing check flags the entire
pipeline.</p>
<hr />
<h2 id="api-orchestration-patterns">API Orchestration Patterns<a class="headerlink" href="#api-orchestration-patterns" title="Permanent link">&para;</a></h2>
<h3 id="multi-source-forecast">Multi-Source Forecast<a class="headerlink" href="#multi-source-forecast" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Chained <code>.map()</code> calls: geocode cities, then fetch
forecasts using the resulting coordinates.</p>
<p><strong>Airflow equivalent:</strong> Multi-city forecast, geocoding (DAGs 081, 086).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="n">coord_futures</span> <span class="o">=</span> <span class="n">geocode_city</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">coord_futures</span><span class="p">]</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="n">forecast_futures</span> <span class="o">=</span> <span class="n">fetch_forecast</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="n">forecasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">forecast_futures</span><span class="p">]</span>
</code></pre></div>
<p>The output of one <code>.map()</code> feeds into the next. All API calls are deterministic
simulations for offline testing.</p>
<hr />
<h3 id="api-pagination">API Pagination<a class="headerlink" href="#api-pagination" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Paginated API consumption with chunked parallel
processing using <code>.map()</code>.</p>
<p><strong>Airflow equivalent:</strong> Chunked API fetching (DAG 094).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="nd">@task</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">simulate_api_page</span><span class="p">(</span><span class="n">page</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">page_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">total_records</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PageResponse</span><span class="p">:</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>    <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_records</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>    <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">page_size</span>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>    <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span><span class="p">,</span> <span class="n">total_records</span><span class="p">)</span>
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>    <span class="n">records</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="o">...</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>    <span class="k">return</span> <span class="n">PageResponse</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="n">records</span><span class="p">,</span> <span class="n">has_next</span><span class="o">=</span><span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<p>Pages are fetched sequentially (next page depends on <code>has_next</code>), then records
are chunked and processed in parallel via <code>.map()</code>.</p>
<hr />
<h3 id="cross-source-enrichment">Cross-Source Enrichment<a class="headerlink" href="#cross-source-enrichment" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Joining data from three simulated API sources with
graceful degradation on partial enrichment failure.</p>
<p><strong>Airflow equivalent:</strong> Cross-API enrichment (DAGs 090, 092).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="nd">@task</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_enrichments</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">demo</span><span class="p">,</span> <span class="n">fin</span><span class="p">,</span> <span class="n">geo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnrichedRecord</span><span class="p">:</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>    <span class="n">sources_available</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">demo</span><span class="p">,</span> <span class="n">fin</span><span class="p">,</span> <span class="n">geo</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>    <span class="n">completeness</span> <span class="o">=</span> <span class="n">sources_available</span> <span class="o">/</span> <span class="mf">3.0</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>    <span class="k">return</span> <span class="n">EnrichedRecord</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">enrichment_completeness</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">completeness</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</code></pre></div>
<p>When an enrichment source returns <code>None</code>, the record continues with partial
data. Completeness is tracked per-record and summarised in the report.</p>
<hr />
<h3 id="response-caching">Response Caching<a class="headerlink" href="#response-caching" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Application-level response cache with TTL expiry,
hashlib-based keys, and hit/miss tracking.</p>
<p><strong>Airflow equivalent:</strong> Forecast accuracy / cached vs fresh comparison (DAG 082).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="nd">@task</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">fetch_with_cache</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">ttl_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>    <span class="n">key</span> <span class="o">=</span> <span class="n">make_cache_key</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>    <span class="n">entry</span> <span class="o">=</span> <span class="n">check_cache</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">ttl_seconds</span><span class="p">)</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>    <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>        <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="kc">True</span>  <span class="c1"># cache hit</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">simulate_api_call</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a>    <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;cached_at&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="kc">False</span>  <span class="c1"># cache miss</span>
</code></pre></div>
<p>Duplicate requests hit the cache. TTL-based expiry prevents stale data.</p>
<hr />
<h2 id="configuration-and-orchestration-patterns">Configuration and Orchestration Patterns<a class="headerlink" href="#configuration-and-orchestration-patterns" title="Permanent link">&para;</a></h2>
<h3 id="config-driven-pipeline">Config-Driven Pipeline<a class="headerlink" href="#config-driven-pipeline" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Pipeline behaviour controlled entirely by a typed
<code>PipelineConfig</code> parameter: stage selection, parameter overrides, conditional
execution. The flow accepts a Pydantic model directly so that Prefect can
auto-generate a rich parameter schema for the UI.</p>
<p><strong>Airflow equivalent:</strong> API-triggered scheduling with config payload (DAG 109).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;data_engineering_config_driven_pipeline&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">config_driven_pipeline_flow</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">PipelineConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PipelineResult</span><span class="p">:</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>    <span class="o">...</span>
</code></pre></div>
<p>Different <code>PipelineConfig</code> values produce different pipeline runs through the
same flow. Disabled stages are skipped automatically.</p>
<hr />
<h3 id="producer-consumer">Producer-Consumer<a class="headerlink" href="#producer-consumer" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Cross-flow communication via file-based data contracts.
Separate producer and consumer flows connected through data packages.</p>
<p><strong>Airflow equivalent:</strong> Asset + XCom producer/consumer (DAG 112).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;data_engineering_producer_consumer&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">producer_consumer_flow</span><span class="p">(</span><span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>    <span class="n">producer_flow</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">producer_id</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>    <span class="n">producer_flow</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">producer_id</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">consumer_flow</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">consumer_id</span><span class="o">=</span><span class="s2">&quot;main_consumer&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Producers write JSON data + metadata files. Consumers discover and process
them. Each is independently testable.</p>
<hr />
<h3 id="circuit-breaker">Circuit Breaker<a class="headerlink" href="#circuit-breaker" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Circuit breaker state machine (closed -&gt; open -&gt;
half_open -&gt; closed). After N consecutive failures, the circuit opens.</p>
<p><strong>Airflow equivalent:</strong> None (Prefect-native resilience pattern).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="nd">@task</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">call_with_circuit</span><span class="p">(</span><span class="n">circuit</span><span class="p">:</span> <span class="n">CircuitState</span><span class="p">,</span> <span class="n">should_succeed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>    <span class="k">if</span> <span class="n">circuit</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;open&quot;</span><span class="p">:</span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>        <span class="n">circuit</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">model_copy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;half_open&quot;</span><span class="p">})</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>    <span class="c1"># ... execute call, track failures, trip if threshold reached</span>
</code></pre></div>
<p>Outcomes are a deterministic list of booleans, making the simulation fully
testable and reproducible.</p>
<hr />
<h3 id="discriminated-unions">Discriminated Unions<a class="headerlink" href="#discriminated-unions" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Pydantic discriminated unions for type-safe
polymorphic event dispatch. The flow accepts a typed <code>list[Event]</code> directly,
giving Prefect a rich parameter schema instead of freeform JSON.</p>
<p><strong>Airflow equivalent:</strong> Multi-API dashboard with heterogeneous sources (DAG 098).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="n">Event</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">EmailEvent</span><span class="p">,</span> <span class="n">WebhookEvent</span><span class="p">,</span> <span class="n">ScheduleEvent</span><span class="p">],</span> <span class="n">Field</span><span class="p">(</span><span class="n">discriminator</span><span class="o">=</span><span class="s2">&quot;event_type&quot;</span><span class="p">)]</span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;data_engineering_discriminated_unions&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">discriminated_unions_flow</span><span class="p">(</span><span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Event</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessingSummary</span><span class="p">:</span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>    <span class="o">...</span>
</code></pre></div>
<p>The <code>event_type</code> literal field acts as a discriminator. Passing typed model
instances directly avoids manual dict parsing inside the flow.</p>
<hr />
<h2 id="production-patterns-and-capstone">Production Patterns and Capstone<a class="headerlink" href="#production-patterns-and-capstone" title="Permanent link">&para;</a></h2>
<h3 id="streaming-batch-processor">Streaming Batch Processor<a class="headerlink" href="#streaming-batch-processor" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Windowed batch processing with anomaly detection
(values &gt; 3 stdev from window mean) and trend analysis between windows.</p>
<p><strong>Airflow equivalent:</strong> GeoJSON parsing, OData pivoting (DAGs 091, 095).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="nd">@task</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_window</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">window</span><span class="p">:</span> <span class="n">BatchWindow</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowResult</span><span class="p">:</span>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">window</span><span class="o">.</span><span class="n">start_index</span><span class="p">:</span><span class="n">window</span><span class="o">.</span><span class="n">end_index</span><span class="p">]]</span>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>    <span class="n">stdev</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>    <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">stdev</span><span class="p">]</span>
</code></pre></div>
<p>Windows are processed in parallel via <code>.map()</code>. Seeded random ensures
reproducible test data.</p>
<hr />
<h3 id="idempotent-operations">Idempotent Operations<a class="headerlink" href="#idempotent-operations" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Hash-based idempotency registry. Operations check
the registry before executing, making them safe to re-run.</p>
<p><strong>Airflow equivalent:</strong> None (production resilience pattern).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="nd">@task</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">idempotent_execute</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a>    <span class="n">op_id</span> <span class="o">=</span> <span class="n">compute_operation_id</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>    <span class="n">existing</span> <span class="o">=</span> <span class="n">check_registry</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">op_id</span><span class="p">)</span>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>    <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>        <span class="k">return</span> <span class="n">registry</span><span class="p">,</span> <span class="n">existing</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="kc">True</span>  <span class="c1"># skipped</span>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">execute_operation</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>    <span class="n">registry</span> <span class="o">=</span> <span class="n">register_operation</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">op_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">op_id</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>    <span class="k">return</span> <span class="n">registry</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="kc">False</span>  <span class="c1"># executed</span>
</code></pre></div>
<p>Duplicate operations are detected by hashing name + inputs. The registry
prevents re-execution.</p>
<hr />
<h3 id="error-recovery">Error Recovery<a class="headerlink" href="#error-recovery" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Checkpoint-based stage recovery. The flow saves
progress after each stage; re-runs skip completed stages.</p>
<p><strong>Airflow equivalent:</strong> None (production resilience combining manifest and
checkpoint ideas).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="nd">@task</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_with_checkpoints</span><span class="p">(</span><span class="n">stages</span><span class="p">,</span> <span class="n">store_path</span><span class="p">,</span> <span class="n">fail_on</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>    <span class="n">store</span> <span class="o">=</span> <span class="n">load_checkpoints</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">store_path</span><span class="p">)</span>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_run_stage</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>            <span class="n">recovered</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>            <span class="k">continue</span>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">execute_stage</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">fail_on</span><span class="p">)</span>
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>        <span class="n">store</span> <span class="o">=</span> <span class="n">save_checkpoint</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">store_path</span><span class="p">)</span>
</code></pre></div>
<p>Fail at stage X, re-run, and stages before X are automatically skipped.</p>
<hr />
<h3 id="production-pipeline-v3">Production Pipeline v3<a class="headerlink" href="#production-pipeline-v3" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Phase 4 capstone combining file I/O, data profiling,
quality rules, enrichment with caching, deduplication, and checkpointing.</p>
<p><strong>Airflow equivalent:</strong> Quality framework + dashboard capstone (DAGs 099, 098).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;data_engineering_production_pipeline_v3&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">production_pipeline_v3_flow</span><span class="p">(</span><span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>    <span class="n">records</span> <span class="o">=</span> <span class="n">ingest_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a>    <span class="n">profile</span> <span class="o">=</span> <span class="n">profile_data</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>    <span class="n">quality</span> <span class="o">=</span> <span class="n">run_quality_checks</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">rules</span><span class="p">)</span>
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>    <span class="n">enriched</span><span class="p">,</span> <span class="n">cache_stats</span> <span class="o">=</span> <span class="n">enrich_records</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>    <span class="n">deduped</span> <span class="o">=</span> <span class="n">deduplicate_records</span><span class="p">(</span><span class="n">enriched</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">])</span>
<a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>    <span class="n">write_output</span><span class="p">(</span><span class="n">deduped</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
<a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a>    <span class="n">build_dashboard</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p>This capstone combines all Phase 4 patterns: CSV file I/O, statistical
profiling, quality rule checks with traffic-light scoring, application-level
caching, hash-based deduplication, checkpoint saving, and a markdown dashboard
artifact.</p>
<hr />
<h2 id="environmental-and-risk-analysis">Environmental and Risk Analysis<a class="headerlink" href="#environmental-and-risk-analysis" title="Permanent link">&para;</a></h2>
<h3 id="air-quality-index">Air Quality Index<a class="headerlink" href="#air-quality-index" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Threshold-based AQI classification against WHO
air quality standards, health advisory generation, and severity ordering.</p>
<p><strong>Airflow equivalent:</strong> Air quality monitoring with WHO thresholds (DAG 083).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="n">AQI_THRESHOLDS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>    <span class="p">(</span><span class="mf">50.0</span><span class="p">,</span> <span class="s2">&quot;Good&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">),</span>
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>    <span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="s2">&quot;Moderate&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">),</span>
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>    <span class="p">(</span><span class="mf">150.0</span><span class="p">,</span> <span class="s2">&quot;Unhealthy for Sensitive Groups&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">),</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>    <span class="p">(</span><span class="mf">200.0</span><span class="p">,</span> <span class="s2">&quot;Unhealthy&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">),</span>
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>    <span class="p">(</span><span class="mf">300.0</span><span class="p">,</span> <span class="s2">&quot;Very Unhealthy&quot;</span><span class="p">,</span> <span class="s2">&quot;purple&quot;</span><span class="p">),</span>
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>    <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span> <span class="s2">&quot;Hazardous&quot;</span><span class="p">,</span> <span class="s2">&quot;maroon&quot;</span><span class="p">),</span>
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a><span class="p">]</span>
<a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>
<a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a><span class="nd">@task</span>
<a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">classify_aqi</span><span class="p">(</span><span class="n">readings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PollutantReading</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AqiClassification</span><span class="p">]:</span>
<a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>    <span class="n">classifications</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AqiClassification</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a>    <span class="k">for</span> <span class="n">reading</span> <span class="ow">in</span> <span class="n">readings</span><span class="p">:</span>
<a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a>        <span class="n">mean_val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">reading</span><span class="o">.</span><span class="n">hourly_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">reading</span><span class="o">.</span><span class="n">hourly_values</span><span class="p">)</span>
<a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a>        <span class="k">for</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">AQI_THRESHOLDS</span><span class="p">:</span>
<a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a>            <span class="k">if</span> <span class="n">mean_val</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-83-17" name="__codelineno-83-17" href="#__codelineno-83-17"></a>                <span class="n">category</span> <span class="o">=</span> <span class="n">cat</span>
<a id="__codelineno-83-18" name="__codelineno-83-18" href="#__codelineno-83-18"></a>                <span class="n">color</span> <span class="o">=</span> <span class="n">col</span>
<a id="__codelineno-83-19" name="__codelineno-83-19" href="#__codelineno-83-19"></a>                <span class="k">break</span>
<a id="__codelineno-83-20" name="__codelineno-83-20" href="#__codelineno-83-20"></a>        <span class="o">...</span>
</code></pre></div>
<p>Readings are classified by walking an ordered list of (threshold, category,
color) tuples. A severity ordering list determines the worst city. WHO limits
are checked separately for exceedance counting.</p>
<hr />
<h3 id="composite-risk-assessment">Composite Risk Assessment<a class="headerlink" href="#composite-risk-assessment" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Multi-source weighted risk scoring combining marine
and flood data into a composite index.</p>
<p><strong>Airflow equivalent:</strong> Marine forecast + flood discharge composite risk (DAG 084).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="nd">@task</span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_composite</span><span class="p">(</span>
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>    <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>    <span class="n">marine_factors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RiskFactor</span><span class="p">],</span>
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>    <span class="n">flood_factors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RiskFactor</span><span class="p">],</span>
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>    <span class="n">marine_weight</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>    <span class="n">flood_weight</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompositeRisk</span><span class="p">:</span>
<a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>    <span class="n">marine_avg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">normalized_score</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">marine_factors</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">marine_factors</span><span class="p">)</span>
<a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>    <span class="n">flood_avg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">normalized_score</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flood_factors</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">flood_factors</span><span class="p">)</span>
<a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a>    <span class="n">weighted</span> <span class="o">=</span> <span class="n">marine_avg</span> <span class="o">*</span> <span class="n">marine_weight</span> <span class="o">+</span> <span class="n">flood_avg</span> <span class="o">*</span> <span class="n">flood_weight</span>
<a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a>    <span class="n">category</span> <span class="o">=</span> <span class="n">_classify_risk</span><span class="p">(</span><span class="n">weighted</span><span class="p">)</span>
<a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a>    <span class="o">...</span>
</code></pre></div>
<p>Raw risk factors are normalized to a 0-100 scale, then combined with
configurable weights (default 60/40 marine/flood). The composite score is
classified into low/moderate/high/critical categories.</p>
<hr />
<h3 id="daylight-analysis">Daylight Analysis<a class="headerlink" href="#daylight-analysis" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Datetime arithmetic for seasonal daylight profiles
and Pearson correlation between latitude and daylight amplitude.</p>
<p><strong>Airflow equivalent:</strong> Sunrise-sunset daylight analysis across latitudes (DAG 085).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="nd">@task</span>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">correlate_latitude_amplitude</span><span class="p">(</span><span class="n">profiles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SeasonalProfile</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a>    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">profiles</span><span class="p">]</span>
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a>    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">amplitude</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">profiles</span><span class="p">]</span>
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>    <span class="n">mean_x</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a>    <span class="n">mean_y</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a>    <span class="n">numerator</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">mean_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">mean_y</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a>    <span class="n">denom_x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">mean_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">))</span>
<a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a>    <span class="n">denom_y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">yi</span> <span class="o">-</span> <span class="n">mean_y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="n">y</span><span class="p">))</span>
<a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a>    <span class="k">return</span> <span class="n">numerator</span> <span class="o">/</span> <span class="p">(</span><span class="n">denom_x</span> <span class="o">*</span> <span class="n">denom_y</span><span class="p">)</span>
</code></pre></div>
<p>Day length is computed using a sinusoidal formula with amplitude proportional to
latitude. The manual Pearson correlation confirms the expected strong positive
relationship between absolute latitude and seasonal daylight variation.</p>
<hr />
<h3 id="statistical-aggregation">Statistical Aggregation<a class="headerlink" href="#statistical-aggregation" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Fan-out aggregation: one dataset, three independent
aggregations (by station, by date, cross-tabulation) running in parallel.</p>
<p><strong>Airflow equivalent:</strong> Parquet-style aggregation with groupby and cross-tab (DAG 057).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="c1"># Fan-out: 3 independent aggregations</span>
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="n">station_future</span> <span class="o">=</span> <span class="n">aggregate_by_group</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">)</span>
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="n">date_future</span> <span class="o">=</span> <span class="n">aggregate_by_group</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">)</span>
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="n">cross_tab_future</span> <span class="o">=</span> <span class="n">build_cross_tab</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">)</span>
<a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a>
<a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="n">station_agg</span> <span class="o">=</span> <span class="n">station_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="n">date_agg</span> <span class="o">=</span> <span class="n">date_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="n">cross_tab</span> <span class="o">=</span> <span class="n">cross_tab_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</code></pre></div>
<p><code>.submit()</code> launches the three aggregations concurrently. The cross-tabulation
builds a station-by-day matrix of mean temperatures using <code>statistics.mean()</code>.</p>
<hr />
<h2 id="economic-and-demographic-analysis">Economic and Demographic Analysis<a class="headerlink" href="#economic-and-demographic-analysis" title="Permanent link">&para;</a></h2>
<h3 id="demographic-analysis">Demographic Analysis<a class="headerlink" href="#demographic-analysis" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Nested JSON normalization into relational tables,
bridge tables for multi-valued fields, and border graph edge construction.</p>
<p><strong>Airflow equivalent:</strong> Country demographics with nested JSON normalization (DAG 087).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="nd">@task</span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_bridge_table</span><span class="p">(</span><span class="n">countries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Country</span><span class="p">],</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">BridgeRecord</span><span class="p">]:</span>
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>    <span class="n">records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BridgeRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">countries</span><span class="p">:</span>
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a>            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BridgeRecord</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">))</span>
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>    <span class="k">return</span> <span class="n">records</span>
</code></pre></div>
<p>Nested JSON fields (languages, currencies) are exploded into bridge tables
linking country to key-value pairs. Border relationships become directed graph
edges. Countries are ranked by population and density.</p>
<hr />
<h3 id="multi-indicator-correlation">Multi-Indicator Correlation<a class="headerlink" href="#multi-indicator-correlation" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Multi-indicator join on (country, year), forward-fill
for missing values, and pairwise Pearson correlation matrix.</p>
<p><strong>Airflow equivalent:</strong> World Bank multi-indicator analysis with correlation (DAG 088).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_pearson</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>    <span class="n">mean_x</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>    <span class="n">mean_y</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a>    <span class="n">num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">mean_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">mean_y</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>    <span class="n">den_x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">mean_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">))</span>
<a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a>    <span class="n">den_y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">yi</span> <span class="o">-</span> <span class="n">mean_y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="n">y</span><span class="p">))</span>
<a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a>    <span class="k">return</span> <span class="n">num</span> <span class="o">/</span> <span class="p">(</span><span class="n">den_x</span> <span class="o">*</span> <span class="n">den_y</span><span class="p">)</span>
</code></pre></div>
<p>Three indicator series (GDP, CO2, Renewable) are joined on country+year,
forward-filled within each country, and then tested for pairwise correlation.
Year-over-year growth rates are also computed.</p>
<hr />
<h3 id="financial-time-series">Financial Time Series<a class="headerlink" href="#financial-time-series" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Log returns, rolling window volatility (annualized),
cross-currency correlation matrix, and anomaly detection via z-score.</p>
<p><strong>Airflow equivalent:</strong> Currency analysis with log returns and volatility (DAG 089).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="nd">@task</span>
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_log_returns</span><span class="p">(</span><span class="n">records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RateRecord</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">LogReturn</span><span class="p">]]:</span>
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>    <span class="o">...</span>
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_rates</span><span class="p">)):</span>
<a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a>        <span class="n">log_ret</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sorted_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rate</span> <span class="o">/</span> <span class="n">sorted_rates</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span>
<a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a>        <span class="n">currency_returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LogReturn</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="n">sorted_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">log_ret</span><span class="p">,</span> <span class="mi">8</span><span class="p">)))</span>
<a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a>    <span class="o">...</span>
</code></pre></div>
<p>Log returns are the natural logarithm of consecutive price ratios. Rolling
volatility is the standard deviation of returns over a window, annualized by
multiplying by sqrt(252). Anomalies are returns exceeding 2 standard deviations.</p>
<hr />
<h3 id="hypothesis-testing">Hypothesis Testing<a class="headerlink" href="#hypothesis-testing" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Educational null-hypothesis pattern: align seismic
and weather datasets, test for correlation, and interpret the (expected near-zero)
result.</p>
<p><strong>Airflow equivalent:</strong> Earthquake-weather correlation / null hypothesis (DAG 093).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="nd">@task</span>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_correlation</span><span class="p">(</span><span class="n">observations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DailyObservation</span><span class="p">],</span> <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesisResult</span><span class="p">:</span>
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">metric_a</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">]</span>
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">metric_b</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">]</span>
<a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>    <span class="n">r_val</span> <span class="o">=</span> <span class="n">_pearson</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>    <span class="n">interpretation</span> <span class="o">=</span> <span class="n">_interpret_result</span><span class="p">(</span><span class="n">r_val</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">))</span>
<a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>    <span class="n">is_significant</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.3</span>
<a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>    <span class="o">...</span>
</code></pre></div>
<p>Two hypotheses are tested (earthquakes vs temperature, earthquakes vs pressure).
Both produce near-zero correlations, confirming the null hypothesis. The absence
of correlation is itself a valid finding.</p>
<hr />
<h2 id="advanced-analytics">Advanced Analytics<a class="headerlink" href="#advanced-analytics" title="Permanent link">&para;</a></h2>
<h3 id="regression-analysis">Regression Analysis<a class="headerlink" href="#regression-analysis" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Manual OLS linear regression with log transformation,
R-squared computation, and residual-based efficiency ranking.</p>
<p><strong>Airflow equivalent:</strong> Health expenditure log-linear regression (DAG 096).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="nd">@task</span>
<a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">linear_regression</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RegressionResult</span><span class="p">:</span>
<a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a>    <span class="n">mean_x</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>    <span class="n">mean_y</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a>    <span class="n">cov_xy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">mean_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">yi</span> <span class="o">-</span> <span class="n">mean_y</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">/</span> <span class="n">n</span>
<a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a>    <span class="n">var_x</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">mean_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
<a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a>    <span class="n">slope</span> <span class="o">=</span> <span class="n">cov_xy</span> <span class="o">/</span> <span class="n">var_x</span> <span class="k">if</span> <span class="n">var_x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a>    <span class="n">intercept</span> <span class="o">=</span> <span class="n">mean_y</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">mean_x</span>
<a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a>    <span class="n">ss_res</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">yi</span> <span class="o">-</span> <span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a>    <span class="n">ss_tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">yi</span> <span class="o">-</span> <span class="n">mean_y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a>    <span class="n">r_squared</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss_res</span> <span class="o">/</span> <span class="n">ss_tot</span><span class="p">)</span> <span class="k">if</span> <span class="n">ss_tot</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-91-12" name="__codelineno-91-12" href="#__codelineno-91-12"></a>    <span class="o">...</span>
</code></pre></div>
<p>Health spending is log-transformed before regression against mortality. Countries
are ranked by residual: negative residual means lower mortality than predicted
(more efficient). No numpy or scipy required.</p>
<hr />
<h3 id="star-schema">Star Schema<a class="headerlink" href="#star-schema" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Dimensional modeling with fact and dimension tables,
surrogate keys, min-max normalization, and weighted composite index ranking.</p>
<p><strong>Airflow equivalent:</strong> Health profile dimensional model (DAG 097).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="nd">@task</span>
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_country_dimension</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DimCountry</span><span class="p">]:</span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a>    <span class="n">dims</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DimCountry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a>        <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DimCountry</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">region</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">],</span> <span class="n">population</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]))</span>
<a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a>    <span class="k">return</span> <span class="n">dims</span>
</code></pre></div>
<p>Three dimension tables (country, time, indicator) and a fact table form a star
schema. Indicators are min-max normalized per the <code>higher_is_better</code> flag, then
weighted to produce a composite country ranking.</p>
<hr />
<h3 id="staged-etl-pipeline">Staged ETL Pipeline<a class="headerlink" href="#staged-etl-pipeline" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Three-layer ETL pipeline: staging (raw load with
timestamp), production (validated + transformed), and summary (grouped stats).</p>
<p><strong>Airflow equivalent:</strong> SQL-based three-layer ETL (DAGs 035-036).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="nd">@task</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate_and_transform</span><span class="p">(</span><span class="n">staging</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">StagingRecord</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ProductionRecord</span><span class="p">]:</span>
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a>    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">staging</span><span class="p">:</span>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a>            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">value_raw</span><span class="p">)</span>
<a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a>            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
<a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a>                <span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
<a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a>            <span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a>        <span class="o">...</span>
</code></pre></div>
<p>Each record carries an <code>is_valid</code> flag through the production layer. Invalid
records are retained but flagged. The summary layer computes grouped statistics
(avg, min, max, count) over valid records only.</p>
<hr />
<h3 id="data-transfer">Data Transfer<a class="headerlink" href="#data-transfer" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Cross-system data synchronization with computed
categorical columns and transfer verification via row count and checksum.</p>
<p><strong>Airflow equivalent:</strong> Generic table-to-table transfer with transformation (DAG 037).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="nd">@task</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">verify_transfer</span><span class="p">(</span><span class="n">sources</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SourceRecord</span><span class="p">],</span> <span class="n">destinations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DestRecord</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TransferVerification</span><span class="p">:</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>    <span class="n">count_match</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">destinations</span><span class="p">)</span>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>    <span class="n">source_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span>
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a>        <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">city</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">population</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">city</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a>    <span class="n">dest_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span>
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a>        <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">city</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">population</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">destinations</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">city</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a>    <span class="k">return</span> <span class="n">TransferVerification</span><span class="p">(</span><span class="n">count_match</span><span class="o">=</span><span class="n">count_match</span><span class="p">,</span> <span class="n">checksum_match</span><span class="o">=</span><span class="n">source_hash</span> <span class="o">==</span> <span class="n">dest_hash</span><span class="p">)</span>
</code></pre></div>
<p>Source records are enriched with a <code>size_category</code> during transfer. Verification
checks both row counts and SHA-256 checksums to ensure data integrity.</p>
<hr />
<h2 id="domain-api-processing">Domain API Processing<a class="headerlink" href="#domain-api-processing" title="Permanent link">&para;</a></h2>
<h3 id="hierarchical-data-processing">Hierarchical Data Processing<a class="headerlink" href="#hierarchical-data-processing" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Tree-structured org unit hierarchy with path-based
depth computation, parent field flattening, and root/leaf identification.</p>
<p><strong>Airflow equivalent:</strong> DHIS2 org unit hierarchy flattening (DAG 058).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="nd">@task</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">flatten_hierarchy</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RawOrgUnit</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">OrgUnit</span><span class="p">]:</span>
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>    <span class="n">units</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">OrgUnit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>        <span class="n">parent_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">parent</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a>        <span class="n">parent_name</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">parent</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a>        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">])</span>
<a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a>        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OrgUnit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
<a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a>                             <span class="n">parent_id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">parent_name</span><span class="o">=</span><span class="n">parent_name</span><span class="p">,</span>
<a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a>                             <span class="n">path</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">hierarchy_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="o">...</span><span class="p">))</span>
<a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a>    <span class="o">...</span>
</code></pre></div>
<p>Nested parent references are flattened to <code>parent_id</code> and <code>parent_name</code> columns.
Hierarchy depth is derived from the path string. Root and leaf nodes are
identified by comparing parent and child ID sets.</p>
<hr />
<h3 id="expression-complexity-scoring">Expression Complexity Scoring<a class="headerlink" href="#expression-complexity-scoring" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Regex-based expression parsing for operand counting,
operator counting, complexity scoring, and binning.</p>
<p><strong>Airflow equivalent:</strong> DHIS2 indicator expression parsing (DAGs 059-060).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="n">OPERAND_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#\{[^}]+\}&quot;</span><span class="p">)</span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a><span class="nd">@task</span>
<a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">score_complexity</span><span class="p">(</span><span class="n">expressions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Expression</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ComplexityScore</span><span class="p">]:</span>
<a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a>    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span>
<a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a>        <span class="n">num_operands</span> <span class="o">=</span> <span class="n">parse_operands</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">numerator</span><span class="p">)</span> <span class="o">+</span> <span class="n">parse_operands</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
<a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a>        <span class="n">num_operators</span> <span class="o">=</span> <span class="n">count_operators</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">numerator</span><span class="p">)</span> <span class="o">+</span> <span class="n">count_operators</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
<a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">num_operands</span> <span class="o">+</span> <span class="n">num_operators</span>
<a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a>        <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a>            <span class="n">bin_label</span> <span class="o">=</span> <span class="s2">&quot;trivial&quot;</span>
<a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a>        <span class="k">elif</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-96-12" name="__codelineno-96-12" href="#__codelineno-96-12"></a>            <span class="n">bin_label</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span>
<a id="__codelineno-96-13" name="__codelineno-96-13" href="#__codelineno-96-13"></a>        <span class="k">elif</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
<a id="__codelineno-96-14" name="__codelineno-96-14" href="#__codelineno-96-14"></a>            <span class="n">bin_label</span> <span class="o">=</span> <span class="s2">&quot;moderate&quot;</span>
<a id="__codelineno-96-15" name="__codelineno-96-15" href="#__codelineno-96-15"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-96-16" name="__codelineno-96-16" href="#__codelineno-96-16"></a>            <span class="n">bin_label</span> <span class="o">=</span> <span class="s2">&quot;complex&quot;</span>
<a id="__codelineno-96-17" name="__codelineno-96-17" href="#__codelineno-96-17"></a>        <span class="o">...</span>
</code></pre></div>
<p>Expressions use <code>#{...}</code> operand syntax. The regex counts operands while a
character scan counts operators. The combined score determines a complexity bin
(trivial/simple/moderate/complex).</p>
<hr />
<h3 id="spatial-data-construction">Spatial Data Construction<a class="headerlink" href="#spatial-data-construction" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Manual GeoJSON-like feature collection construction,
bounding box computation from point geometries, and geometry type filtering.</p>
<p><strong>Airflow equivalent:</strong> DHIS2 org unit geometry / GeoJSON construction (DAG 061).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="nd">@task</span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_bounding_box</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Feature</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a>    <span class="n">lons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a>    <span class="n">lats</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a>    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
<a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">geometry_type</span> <span class="o">==</span> <span class="s2">&quot;Point&quot;</span><span class="p">:</span>
<a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a>            <span class="n">lons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a>            <span class="n">lats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a>    <span class="k">return</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lats</span><span class="p">)]</span>
</code></pre></div>
<p>Features with Point and Polygon geometry types are assembled into a collection.
The bounding box is computed from point coordinates as [min_lon, min_lat,
max_lon, max_lat].</p>
<hr />
<h3 id="parallel-multi-endpoint-export">Parallel Multi-Endpoint Export<a class="headerlink" href="#parallel-multi-endpoint-export" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Parallel independent endpoint processing with
heterogeneous output formats (CSV + JSON) and fan-in summary.</p>
<p><strong>Airflow equivalent:</strong> DHIS2 combined parallel export (DAG 062).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="c1"># Fan-out: 3 parallel endpoint fetches</span>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="n">future_a</span> <span class="o">=</span> <span class="n">fetch_endpoint_a</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
<a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a><span class="n">future_b</span> <span class="o">=</span> <span class="n">fetch_endpoint_b</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
<a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a><span class="n">future_c</span> <span class="o">=</span> <span class="n">fetch_endpoint_c</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
<a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a>
<a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a><span class="n">result_a</span> <span class="o">=</span> <span class="n">future_a</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a><span class="n">result_b</span> <span class="o">=</span> <span class="n">future_b</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a><span class="n">result_c</span> <span class="o">=</span> <span class="n">future_c</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a>
<a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a><span class="n">summary</span> <span class="o">=</span> <span class="n">combine_results</span><span class="p">([</span><span class="n">result_a</span><span class="p">,</span> <span class="n">result_b</span><span class="p">,</span> <span class="n">result_c</span><span class="p">],</span> <span class="n">duration</span><span class="p">)</span>
</code></pre></div>
<p>Three endpoints are fetched in parallel via <code>.submit()</code>, writing CSV and JSON
files. Results are combined into a summary with total record count and format
distribution.</p>
<hr />
<h2 id="advanced-patterns-and-grand-capstone">Advanced Patterns and Grand Capstone<a class="headerlink" href="#advanced-patterns-and-grand-capstone" title="Permanent link">&para;</a></h2>
<h3 id="data-lineage-tracking">Data Lineage Tracking<a class="headerlink" href="#data-lineage-tracking" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Hash-based provenance tracking through pipeline
stages, building a lineage graph from ingest through filter, enrich, and dedup.</p>
<p><strong>Airflow equivalent:</strong> None (Prefect-native pattern).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="nd">@task</span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_data_hash</span><span class="p">(</span><span class="n">records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataRecord</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a>    <span class="n">raw</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">))</span>
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a>    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>
<a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a><span class="nd">@task</span>
<a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">transform_filter</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">min_value</span><span class="p">):</span>
<a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a>    <span class="n">input_hash</span> <span class="o">=</span> <span class="n">compute_data_hash</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a>    <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">min_value</span><span class="p">]</span>
<a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a>    <span class="n">output_hash</span> <span class="o">=</span> <span class="n">compute_data_hash</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>
<a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a>    <span class="n">entry</span> <span class="o">=</span> <span class="n">record_lineage</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;filter_by_value&quot;</span><span class="p">,</span> <span class="n">input_hash</span><span class="p">,</span> <span class="n">output_hash</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>
<a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a>    <span class="k">return</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">entry</span>
</code></pre></div>
<p>Every transformation records its input and output hashes, creating a chain of
lineage entries. The lineage graph tracks how data changes through each stage
and counts data-modifying operations (where input_hash differs from output_hash).</p>
<hr />
<h3 id="pipeline-template-factory">Pipeline Template Factory<a class="headerlink" href="#pipeline-template-factory" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Reusable pipeline templates with ordered stage slots,
instantiated with different configurations via the factory pattern.</p>
<p><strong>Airflow equivalent:</strong> None (Prefect-native pattern).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="nd">@task</span>
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">:</span> <span class="n">StageTemplate</span><span class="p">,</span> <span class="n">overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StageResult</span><span class="p">:</span>
<a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a>    <span class="n">merged</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">stage</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="n">overrides</span><span class="p">}</span>
<a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a>    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">stage_type</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
<a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a>        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">merged</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a>    <span class="k">elif</span> <span class="n">stage</span><span class="o">.</span><span class="n">stage_type</span> <span class="o">==</span> <span class="s2">&quot;validate&quot;</span><span class="p">:</span>
<a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a>        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">merged</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">merged</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pass_rate&quot;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)))</span>
<a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a>    <span class="o">...</span>
</code></pre></div>
<p>Templates define ordered stages with default parameters. Instantiation merges
overrides into defaults. The same template produces different pipelines depending
on the configuration, demonstrating code reuse without duplication.</p>
<hr />
<h3 id="multi-pipeline-orchestrator">Multi-Pipeline Orchestrator<a class="headerlink" href="#multi-pipeline-orchestrator" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Orchestration of multiple independent mini-pipelines
with status collection and overall health rollup.</p>
<p><strong>Airflow equivalent:</strong> None (Prefect-native pattern).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="nd">@task</span>
<a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_status</span><span class="p">(</span><span class="n">statuses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PipelineStatus</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">OrchestratorResult</span><span class="p">:</span>
<a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a>    <span class="n">successful</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">statuses</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span>
<a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a>    <span class="n">failed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statuses</span><span class="p">)</span> <span class="o">-</span> <span class="n">successful</span>
<a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a>    <span class="k">if</span> <span class="n">failed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a>        <span class="n">overall</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
<a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a>    <span class="k">elif</span> <span class="n">failed</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">statuses</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a>        <span class="n">overall</span> <span class="o">=</span> <span class="s2">&quot;degraded&quot;</span>
<a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a>        <span class="n">overall</span> <span class="o">=</span> <span class="s2">&quot;critical&quot;</span>
<a id="__codelineno-101-11" name="__codelineno-101-11" href="#__codelineno-101-11"></a>    <span class="o">...</span>
</code></pre></div>
<p>Four independent pipelines (ingest, transform, export, quality) run and report
status. The orchestrator aggregates results into healthy/degraded/critical based
on majority voting and produces a markdown report.</p>
<hr />
<h3 id="grand-capstone">Grand Capstone<a class="headerlink" href="#grand-capstone" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> End-to-end analytics pipeline combining patterns from
all 5 phases: CSV I/O, profiling, quality checks, enrichment, deduplication,
regression, dimensional modeling, lineage tracking, and a dashboard artifact.</p>
<p><strong>Airflow equivalent:</strong> None (combines patterns from all 5 phases).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;analytics_grand_capstone&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">grand_capstone_flow</span><span class="p">(</span><span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CapstoneResult</span><span class="p">:</span>
<a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>    <span class="n">records</span> <span class="o">=</span> <span class="n">ingest_data</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
<a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>    <span class="n">profile_data</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a>    <span class="n">quality</span> <span class="o">=</span> <span class="n">run_quality_checks</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a>    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">enrich_and_deduplicate</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a>    <span class="n">regression</span> <span class="o">=</span> <span class="n">run_regression</span><span class="p">(</span><span class="n">cleaned</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">)</span>
<a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a>    <span class="n">dimensions</span> <span class="o">=</span> <span class="n">build_dimensions</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
<a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a>    <span class="n">lineage</span> <span class="o">=</span> <span class="n">track_lineage</span><span class="p">(</span><span class="n">stages</span><span class="p">)</span>
<a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a>    <span class="n">build_capstone_dashboard</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-102-11" name="__codelineno-102-11" href="#__codelineno-102-11"></a>    <span class="o">...</span>
</code></pre></div>
<p>This final flow ties together every major concept from Phase 1 through Phase 5:
file ingestion, statistical profiling, quality rule checking, hash-based
deduplication, OLS regression, dimensional modeling with composite ranking,
lineage tracking, and a rich markdown dashboard artifact.</p>
<hr />
<h2 id="dhis2-integration-101-108">DHIS2 Integration (101--108)<a class="headerlink" href="#dhis2-integration-101-108" title="Permanent link">&para;</a></h2>
<h3 id="dhis2-connection-block">DHIS2 Connection Block<a class="headerlink" href="#dhis2-connection-block" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Custom Prefect block with methods for DHIS2 API
operations, <code>SecretStr</code> for password management, connection verification.</p>
<p><strong>Airflow equivalent:</strong> <code>BaseHook.get_connection("dhis2_default")</code> (DAG 110).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Dhis2Credentials</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a>    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;https://play.im.dhis2.org/dev&quot;</span>
<a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a>    <span class="n">password</span><span class="p">:</span> <span class="n">SecretStr</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">SecretStr</span><span class="p">(</span><span class="s2">&quot;district&quot;</span><span class="p">))</span>
<a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a>
<a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dhis2Client</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a>
<a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Dhis2Client</span><span class="p">:</span>
<a id="__codelineno-103-9" name="__codelineno-103-9" href="#__codelineno-103-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_server_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-103-10" name="__codelineno-103-10" href="#__codelineno-103-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span> <span class="o">...</span>
<a id="__codelineno-103-11" name="__codelineno-103-11" href="#__codelineno-103-11"></a>
<a id="__codelineno-103-12" name="__codelineno-103-12" href="#__codelineno-103-12"></a><span class="n">creds</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">()</span>       <span class="c1"># Block.load() with fallback</span>
<a id="__codelineno-103-13" name="__codelineno-103-13" href="#__codelineno-103-13"></a><span class="n">client</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-103-14" name="__codelineno-103-14" href="#__codelineno-103-14"></a><span class="n">info</span> <span class="o">=</span> <span class="n">get_connection_info</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span>     <span class="c1"># SecretStr handles masking</span>
<a id="__codelineno-103-15" name="__codelineno-103-15" href="#__codelineno-103-15"></a><span class="n">verify_connection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">creds</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>  <span class="c1"># uses client.get_server_info()</span>
</code></pre></div>
<p>The Airflow pattern <code>BaseHook.get_connection()</code> maps to <code>Block.load()</code> in
Prefect. Password is stored as <code>SecretStr</code> directly on the block (encrypted
at rest when saved to the server). <code>get_client()</code> returns a <code>Dhis2Client</code>
that handles API calls -- callers never touch the password directly.</p>
<hr />
<h3 id="dhis2-block-connection">DHIS2 Block Connection<a class="headerlink" href="#dhis2-block-connection" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Named credentials block loading so different DHIS2
instances (play, staging, production) can be targeted at runtime via a single
<code>instance</code> parameter.</p>
<p><strong>Airflow equivalent:</strong> Multiple connections by conn_id.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_block_connection&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_block_connection_flow</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dhis2&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConnectionInfo</span><span class="p">:</span>
<a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a>    <span class="n">creds</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>  <span class="c1"># loads named block</span>
<a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">get_connection_info</span><span class="p">(</span><span class="n">creds</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
<a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a>    <span class="n">verify_connection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">creds</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
<a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a>    <span class="n">count</span> <span class="o">=</span> <span class="n">fetch_org_unit_count</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a>    <span class="n">display_connection</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</code></pre></div>
<p>Save multiple <code>Dhis2Credentials</code> blocks (e.g. <code>"dhis2"</code>, <code>"dhis2-staging"</code>,
<code>"dhis2-prod"</code>) and pass the block name as the <code>instance</code> parameter. The
flow loads whichever block you specify, falling back to default play-server
credentials when no saved block exists.</p>
<hr />
<h3 id="dhis2-org-units-api">DHIS2 Org Units API<a class="headerlink" href="#dhis2-org-units-api" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Block-authenticated metadata fetch, nested JSON
flattening with Pydantic, derived columns (hierarchy depth, translation count).</p>
<p><strong>Airflow equivalent:</strong> DHIS2 org unit fetch (DAG 058).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="nd">@task</span>
<a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">flatten_org_units</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RawOrgUnit</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">FlatOrgUnit</span><span class="p">]:</span>
<a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a>    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
<a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>        <span class="n">parent_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">parent</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a>        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">])</span>
<a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a>        <span class="n">flat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FlatOrgUnit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
<a id="__codelineno-105-7" name="__codelineno-105-7" href="#__codelineno-105-7"></a>                                <span class="n">parent_id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">hierarchy_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="o">...</span><span class="p">))</span>
</code></pre></div>
<p>Nested DHIS2 JSON (parent.id, createdBy.username) is extracted into flat
columns. Hierarchy depth is computed from path segment count.</p>
<hr />
<h3 id="dhis2-data-elements-api">DHIS2 Data Elements API<a class="headerlink" href="#dhis2-data-elements-api" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Metadata categorization with block auth, boolean
derived columns, valueType/aggregationType grouping.</p>
<p><strong>Airflow equivalent:</strong> DHIS2 data element fetch (DAG 059).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="nd">@task</span>
<a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">flatten_data_elements</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RawDataElement</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">FlatDataElement</span><span class="p">]:</span>
<a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a>    <span class="n">cc_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">categoryCombo</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">categoryCombo</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a>    <span class="n">flat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FlatDataElement</span><span class="p">(</span>
<a id="__codelineno-106-5" name="__codelineno-106-5" href="#__codelineno-106-5"></a>        <span class="n">category_combo_id</span><span class="o">=</span><span class="n">cc_id</span><span class="p">,</span>
<a id="__codelineno-106-6" name="__codelineno-106-6" href="#__codelineno-106-6"></a>        <span class="n">has_code</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-106-7" name="__codelineno-106-7" href="#__codelineno-106-7"></a>        <span class="n">name_length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="o">...</span><span class="p">))</span>
</code></pre></div>
<p>Each data element is categorized by value type and aggregation type. Boolean
<code>has_code</code> and numeric <code>name_length</code> are derived columns.</p>
<hr />
<h3 id="dhis2-indicators-api">DHIS2 Indicators API<a class="headerlink" href="#dhis2-indicators-api" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Expression parsing with regex, operand counting,
complexity scoring and binning.</p>
<p><strong>Airflow equivalent:</strong> DHIS2 indicator fetch (DAG 060).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="n">OPERAND_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#\{[^}]+\}&quot;</span><span class="p">)</span>
<a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a>
<a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a><span class="n">num_ops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">OPERAND_PATTERN</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">expression</span><span class="p">))</span>
<a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a><span class="n">num_operators</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expression</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;+-*/&quot;</span><span class="p">)</span>
<a id="__codelineno-107-5" name="__codelineno-107-5" href="#__codelineno-107-5"></a><span class="n">complexity</span> <span class="o">=</span> <span class="n">num_ops</span> <span class="o">+</span> <span class="n">den_ops</span> <span class="o">+</span> <span class="n">num_operators</span>
<a id="__codelineno-107-6" name="__codelineno-107-6" href="#__codelineno-107-6"></a><span class="n">complexity_bin</span> <span class="o">=</span> <span class="s2">&quot;trivial&quot;</span> <span class="k">if</span> <span class="n">complexity</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">...</span>
</code></pre></div>
<p>DHIS2 indicator expressions use <code>#{uid.uid}</code> operands. The regex counts them,
operators are counted separately, and a combined score is binned into
trivial/simple/moderate/complex.</p>
<hr />
<h3 id="dhis2-org-unit-geometry">DHIS2 Org Unit Geometry<a class="headerlink" href="#dhis2-org-unit-geometry" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> GeoJSON construction with block auth, geometry
filtering, bounding box computation.</p>
<p><strong>Airflow equivalent:</strong> DHIS2 org unit geometry export (DAG 061).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="nd">@task</span>
<a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_collection</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">GeoFeature</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">GeoCollection</span><span class="p">:</span>
<a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a>    <span class="n">all_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">_extract_coords</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>
<a id="__codelineno-108-4" name="__codelineno-108-4" href="#__codelineno-108-4"></a>    <span class="n">bbox</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lats</span><span class="p">)]</span>
<a id="__codelineno-108-5" name="__codelineno-108-5" href="#__codelineno-108-5"></a>    <span class="k">return</span> <span class="n">GeoCollection</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">)</span>
</code></pre></div>
<p>Org units with geometry are converted to GeoJSON Features. A FeatureCollection
with bounding box is built and written to <code>.geojson</code>.</p>
<hr />
<h3 id="dhis2-combined-export">DHIS2 Combined Export<a class="headerlink" href="#dhis2-combined-export" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Parallel multi-endpoint fetch with shared block,
fan-in summary across heterogeneous outputs.</p>
<p><strong>Airflow equivalent:</strong> DHIS2 combined parallel export (DAG 062).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a><span class="n">client</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a><span class="n">future_ou</span> <span class="o">=</span> <span class="n">export_org_units</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
<a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a><span class="n">future_de</span> <span class="o">=</span> <span class="n">export_data_elements</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
<a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a><span class="n">future_ind</span> <span class="o">=</span> <span class="n">export_indicators</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
<a id="__codelineno-109-5" name="__codelineno-109-5" href="#__codelineno-109-5"></a>
<a id="__codelineno-109-6" name="__codelineno-109-6" href="#__codelineno-109-6"></a><span class="n">report</span> <span class="o">=</span> <span class="n">combined_report</span><span class="p">([</span><span class="n">future_ou</span><span class="o">.</span><span class="n">result</span><span class="p">(),</span> <span class="n">future_de</span><span class="o">.</span><span class="n">result</span><span class="p">(),</span>
<a id="__codelineno-109-7" name="__codelineno-109-7" href="#__codelineno-109-7"></a>                          <span class="n">future_ind</span><span class="o">.</span><span class="n">result</span><span class="p">()])</span>
</code></pre></div>
<p>A shared <code>Dhis2Client</code> is created once from the credentials block, then passed
to three parallel <code>.submit()</code> calls. The combined report tracks total records
and format distribution (CSV vs JSON).</p>
<hr />
<h3 id="dhis2-analytics-query">DHIS2 Analytics Query<a class="headerlink" href="#dhis2-analytics-query" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Analytics API with dimension parameters, headers+rows
response parsing, query parameter construction.</p>
<p><strong>Airflow equivalent:</strong> DHIS2 data values / analytics (DAG 111).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="nd">@task</span>
<a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_analytics</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">RawAnalyticsResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AnalyticsRow</span><span class="p">]:</span>
<a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a>    <span class="n">header_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">]</span>
<a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a>    <span class="k">for</span> <span class="n">row_data</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
<a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a>        <span class="n">record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">header_names</span><span class="p">,</span> <span class="n">row_data</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a>        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AnalyticsRow</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">],</span> <span class="n">ou</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;ou&quot;</span><span class="p">],</span> <span class="o">...</span><span class="p">))</span>
</code></pre></div>
<p>The DHIS2 analytics API returns headers and rows separately. This flow builds
dimension queries, fetches results, and parses the tabular response into typed
records.</p>
<hr />
<h3 id="dhis2-full-pipeline">DHIS2 Full Pipeline<a class="headerlink" href="#dhis2-full-pipeline" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> End-to-end DHIS2 pipeline with block config, quality
checks, timing, and markdown dashboard.</p>
<p><strong>Airflow equivalent:</strong> None (capstone combining all DHIS2 patterns).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_pipeline&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_pipeline_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dhis2PipelineResult</span><span class="p">:</span>
<a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a>    <span class="n">creds</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">()</span>
<a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a>    <span class="n">connect_and_verify</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">creds</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
<a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="n">fetch_all_metadata</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a>    <span class="n">quality</span> <span class="o">=</span> <span class="n">validate_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
<a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a>    <span class="n">build_dashboard</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p>The credentials block provides a <code>Dhis2Client</code> used throughout the pipeline.
A three-stage pipeline (connect, fetch, validate) with per-stage timing,
quality scoring, and a markdown dashboard artifact. This is the DHIS2 capstone.</p>
<hr />
<h3 id="dhis2-world-bank-population-import">DHIS2 World Bank Population Import<a class="headerlink" href="#dhis2-world-bank-population-import" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> First <em>write</em> flow -- fetches World Bank population
data (SP.POP.TOTL) and imports it into a DHIS2 data element via
<code>POST /api/dataValueSets</code>.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator chain with World Bank fetch + DHIS2 POST.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_worldbank_population_import&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_worldbank_population_import_flow</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">ImportQuery</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImportResult</span><span class="p">:</span>
<a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-112-4" name="__codelineno-112-4" href="#__codelineno-112-4"></a>    <span class="n">populations</span> <span class="o">=</span> <span class="n">fetch_population_data</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">iso3_codes</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">start_year</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">end_year</span><span class="p">)</span>
<a id="__codelineno-112-5" name="__codelineno-112-5" href="#__codelineno-112-5"></a>    <span class="n">org_unit_map</span> <span class="o">=</span> <span class="n">resolve_org_units</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">iso3_codes</span><span class="p">)</span>
<a id="__codelineno-112-6" name="__codelineno-112-6" href="#__codelineno-112-6"></a>    <span class="n">data_values</span> <span class="o">=</span> <span class="n">build_data_values</span><span class="p">(</span><span class="n">populations</span><span class="p">,</span> <span class="n">org_unit_map</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data_element_uid</span><span class="p">)</span>
<a id="__codelineno-112-7" name="__codelineno-112-7" href="#__codelineno-112-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">import_data_values</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data_values</span><span class="p">)</span>
<a id="__codelineno-112-8" name="__codelineno-112-8" href="#__codelineno-112-8"></a>    <span class="n">create_markdown_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dhis2-worldbank-import&quot;</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">markdown</span><span class="p">)</span>
</code></pre></div>
<p>Four tasks form a pipeline: (1) batch-fetch population from the World Bank API,
(2) resolve ISO3 codes to DHIS2 org unit UIDs, (3) build data values matching the
DHIS2 <code>dataValueSets</code> schema, (4) POST and parse the import summary. Unresolved
ISO3 codes are logged as warnings and skipped. Retry-enabled tasks handle transient
API failures on both the World Bank and DHIS2 sides.</p>
<hr />
<h3 id="dhis2-world-bank-health-indicators-import">DHIS2 World Bank Health Indicators Import<a class="headerlink" href="#dhis2-world-bank-health-indicators-import" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Fetches 10 World Bank health indicators and imports
them into DHIS2 as data values across 10 data elements within a single data set.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator chain with World Bank fetch + DHIS2 POST.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_worldbank_health_import&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_worldbank_health_import_flow</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">HealthQuery</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImportResult</span><span class="p">:</span>
<a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a>    <span class="n">org_unit</span> <span class="o">=</span> <span class="n">ensure_dhis2_metadata</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a>    <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">INDICATORS</span><span class="p">:</span>
<a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a>        <span class="n">all_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fetch_wb_data</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="o">...</span><span class="p">))</span>
<a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a>    <span class="n">data_values</span> <span class="o">=</span> <span class="n">build_data_values</span><span class="p">(</span><span class="n">org_unit</span><span class="p">,</span> <span class="n">all_values</span><span class="p">)</span>
<a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">import_to_dhis2</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dhis2_url</span><span class="p">,</span> <span class="n">org_unit</span><span class="p">,</span> <span class="n">data_values</span><span class="p">)</span>
<a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a>    <span class="n">create_markdown_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dhis2-worldbank-health-import&quot;</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">markdown</span><span class="p">)</span>
</code></pre></div>
<p>Four tasks form a pipeline: (1) ensure 10 data elements and 1 data set exist in
DHIS2, (2) fetch each indicator from the World Bank API in a loop, (3) build data
values mapping indicator results to DHIS2 data element UIDs, (4) POST all values
in a single import. Covers indicators including under-5 mortality, life expectancy,
health expenditure, TB incidence, measles immunization, stunting, and more.</p>
<hr />
<h3 id="dhis2-worldpop-population-import">DHIS2 WorldPop Population Import<a class="headerlink" href="#dhis2-worldpop-population-import" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Reads org unit polygon boundaries from DHIS2, queries
the WorldPop age-sex API for gridded population estimates, and writes
sex-disaggregated results back using DHIS2 category combinations.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator chain with geometry fetch + WorldPop query + DHIS2 POST.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_worldpop_population_import&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_worldpop_population_import_flow</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">ImportQuery</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImportResult</span><span class="p">:</span>
<a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a>    <span class="n">org_units</span><span class="p">,</span> <span class="n">coc_mapping</span> <span class="o">=</span> <span class="n">ensure_dhis2_metadata</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a>    <span class="k">for</span> <span class="n">ou</span> <span class="ow">in</span> <span class="n">org_units</span><span class="p">:</span>
<a id="__codelineno-114-6" name="__codelineno-114-6" href="#__codelineno-114-6"></a>        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fetch_worldpop_population</span><span class="p">(</span><span class="n">ou</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
<a id="__codelineno-114-7" name="__codelineno-114-7" href="#__codelineno-114-7"></a>    <span class="n">data_values</span> <span class="o">=</span> <span class="n">build_data_values</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">coc_mapping</span><span class="p">)</span>
<a id="__codelineno-114-8" name="__codelineno-114-8" href="#__codelineno-114-8"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">import_to_dhis2</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dhis2_url</span><span class="p">,</span> <span class="n">org_units</span><span class="p">,</span> <span class="n">data_values</span><span class="p">)</span>
<a id="__codelineno-114-9" name="__codelineno-114-9" href="#__codelineno-114-9"></a>    <span class="n">create_markdown_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dhis2-worldpop-population-import&quot;</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">markdown</span><span class="p">)</span>
</code></pre></div>
<p>Four tasks form a pipeline: (1) ensure category options, category, category
combo, data element, and data set exist in DHIS2 -- then resolve auto-generated
categoryOptionCombo UIDs, (2) query the WorldPop <code>wpgpas</code> API for each org unit
polygon, summing M_0..M_16 for male and F_0..F_16 for female totals, (3) build
data values with categoryOptionCombo disaggregation (2 per org unit), (4) POST
all values in a single import. Org units with Point geometry are skipped.</p>
<hr />
<h2 id="connection-patterns">Connection Patterns<a class="headerlink" href="#connection-patterns" title="Permanent link">&para;</a></h2>
<h3 id="environment-based-configuration">Environment-Based Configuration<a class="headerlink" href="#environment-based-configuration" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Four configuration strategies: inline blocks, Secret
blocks, environment variables, JSON config. Compares all approaches in a
single flow.</p>
<p><strong>Airflow equivalent:</strong> None (Prefect-native pattern).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a><span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">from_inline_block</span><span class="p">())</span>    <span class="c1"># Dhis2Credentials()</span>
<a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a><span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">from_secret_block</span><span class="p">())</span>    <span class="c1"># Secret.load()</span>
<a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a><span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">from_env_var</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">))</span>    <span class="c1"># os.environ.get()</span>
<a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a><span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">from_json_config</span><span class="p">())</span>     <span class="c1"># JSON.load()</span>
<a id="__codelineno-115-5" name="__codelineno-115-5" href="#__codelineno-115-5"></a><span class="n">report</span> <span class="o">=</span> <span class="n">compare_strategies</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
</code></pre></div>
<p>Each strategy is loaded with graceful fallback. The comparison report shows
which strategies are available in the current environment.</p>
<hr />
<h3 id="authenticated-api-pipeline">Authenticated API Pipeline<a class="headerlink" href="#authenticated-api-pipeline" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Reusable pattern for any authenticated API: API key,
bearer token, and basic auth. Generic API client block with pluggable auth.</p>
<p><strong>Airflow equivalent:</strong> None (general pattern).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ApiAuthConfig</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
<a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a>    <span class="n">auth_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &quot;api_key&quot;, &quot;bearer&quot;, &quot;basic&quot;</span>
<a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a>    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-116-4" name="__codelineno-116-4" href="#__codelineno-116-4"></a>
<a id="__codelineno-116-5" name="__codelineno-116-5" href="#__codelineno-116-5"></a><span class="nd">@task</span>
<a id="__codelineno-116-6" name="__codelineno-116-6" href="#__codelineno-116-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_auth_header</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">ApiAuthConfig</span><span class="p">,</span> <span class="n">credentials</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AuthHeader</span><span class="p">:</span>
<a id="__codelineno-116-7" name="__codelineno-116-7" href="#__codelineno-116-7"></a>    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s2">&quot;api_key&quot;</span><span class="p">:</span>
<a id="__codelineno-116-8" name="__codelineno-116-8" href="#__codelineno-116-8"></a>        <span class="k">return</span> <span class="n">AuthHeader</span><span class="p">(</span><span class="n">header_name</span><span class="o">=</span><span class="s2">&quot;X-API-Key&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<a id="__codelineno-116-9" name="__codelineno-116-9" href="#__codelineno-116-9"></a>    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s2">&quot;bearer&quot;</span><span class="p">:</span>
<a id="__codelineno-116-10" name="__codelineno-116-10" href="#__codelineno-116-10"></a>        <span class="k">return</span> <span class="n">AuthHeader</span><span class="p">(</span><span class="n">header_name</span><span class="o">=</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="n">header_value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Bearer ...&quot;</span><span class="p">)</span>
<a id="__codelineno-116-11" name="__codelineno-116-11" href="#__codelineno-116-11"></a>    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
<a id="__codelineno-116-12" name="__codelineno-116-12" href="#__codelineno-116-12"></a>        <span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-116-13" name="__codelineno-116-13" href="#__codelineno-116-13"></a>        <span class="k">return</span> <span class="n">AuthHeader</span><span class="p">(</span><span class="n">header_name</span><span class="o">=</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="n">header_value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Basic ...&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Three authentication strategies are tested against a simulated API. The block
pattern is reusable for any authenticated HTTP service.</p>
<hr />
<h2 id="cloud-storage">Cloud Storage<a class="headerlink" href="#cloud-storage" title="Permanent link">&para;</a></h2>
<h3 id="s3-parquet-export">S3 Parquet Export<a class="headerlink" href="#s3-parquet-export" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Generate sample data as Pydantic models, transform
with pandas, and write parquet to S3-compatible storage (RustFS/MinIO) using
prefect-aws blocks.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator + S3Hook.upload_file().</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SensorReading</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a>    <span class="n">station</span><span class="p">:</span> <span class="n">StationId</span>
<a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a>    <span class="n">date</span><span class="p">:</span> <span class="n">date</span>
<a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a>    <span class="n">temperature_c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=-</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span>
<a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a>    <span class="n">humidity_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
<a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a>    <span class="n">status</span><span class="p">:</span> <span class="n">OperationalStatus</span>
<a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a>
<a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a>    <span class="nd">@computed_field</span>
<a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a>    <span class="nd">@property</span>
<a id="__codelineno-117-10" name="__codelineno-117-10" href="#__codelineno-117-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">heat_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-117-11" name="__codelineno-117-11" href="#__codelineno-117-11"></a>        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature_c</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">humidity_pct</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-117-12" name="__codelineno-117-12" href="#__codelineno-117-12"></a>
<a id="__codelineno-117-13" name="__codelineno-117-13" href="#__codelineno-117-13"></a>    <span class="nd">@computed_field</span>
<a id="__codelineno-117-14" name="__codelineno-117-14" href="#__codelineno-117-14"></a>    <span class="nd">@property</span>
<a id="__codelineno-117-15" name="__codelineno-117-15" href="#__codelineno-117-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">temp_category</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TempCategory</span><span class="p">:</span>
<a id="__codelineno-117-16" name="__codelineno-117-16" href="#__codelineno-117-16"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_c</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-117-17" name="__codelineno-117-17" href="#__codelineno-117-17"></a>            <span class="k">return</span> <span class="n">TempCategory</span><span class="o">.</span><span class="n">COLD</span>
<a id="__codelineno-117-18" name="__codelineno-117-18" href="#__codelineno-117-18"></a>        <span class="o">...</span>
<a id="__codelineno-117-19" name="__codelineno-117-19" href="#__codelineno-117-19"></a>
<a id="__codelineno-117-20" name="__codelineno-117-20" href="#__codelineno-117-20"></a><span class="nd">@task</span>
<a id="__codelineno-117-21" name="__codelineno-117-21" href="#__codelineno-117-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">transform_to_dataframe</span><span class="p">(</span><span class="n">readings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SensorReading</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TransformResult</span><span class="p">:</span>
<a id="__codelineno-117-22" name="__codelineno-117-22" href="#__codelineno-117-22"></a>    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">readings</span><span class="p">]</span>
<a id="__codelineno-117-23" name="__codelineno-117-23" href="#__codelineno-117-23"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<a id="__codelineno-117-24" name="__codelineno-117-24" href="#__codelineno-117-24"></a>    <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
<a id="__codelineno-117-25" name="__codelineno-117-25" href="#__codelineno-117-25"></a>    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;pyarrow&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-117-26" name="__codelineno-117-26" href="#__codelineno-117-26"></a>    <span class="k">return</span> <span class="n">TransformResult</span><span class="p">(</span><span class="n">parquet_data</span><span class="o">=</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="o">...</span><span class="p">)</span>
<a id="__codelineno-117-27" name="__codelineno-117-27" href="#__codelineno-117-27"></a>
<a id="__codelineno-117-28" name="__codelineno-117-28" href="#__codelineno-117-28"></a><span class="nd">@task</span>
<a id="__codelineno-117-29" name="__codelineno-117-29" href="#__codelineno-117-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">upload_to_s3</span><span class="p">(</span><span class="n">transform</span><span class="p">:</span> <span class="n">TransformResult</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UploadResult</span><span class="p">:</span>
<a id="__codelineno-117-30" name="__codelineno-117-30" href="#__codelineno-117-30"></a>    <span class="n">minio_creds</span> <span class="o">=</span> <span class="n">MinIOCredentials</span><span class="p">(</span><span class="n">minio_root_user</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<a id="__codelineno-117-31" name="__codelineno-117-31" href="#__codelineno-117-31"></a>    <span class="n">bucket</span> <span class="o">=</span> <span class="n">S3Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;prefect-data&quot;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">minio_creds</span><span class="p">,</span>
<a id="__codelineno-117-32" name="__codelineno-117-32" href="#__codelineno-117-32"></a>                      <span class="n">aws_client_parameters</span><span class="o">=</span><span class="n">AwsClientParameters</span><span class="p">(</span><span class="n">endpoint_url</span><span class="o">=...</span><span class="p">))</span>
<a id="__codelineno-117-33" name="__codelineno-117-33" href="#__codelineno-117-33"></a>    <span class="n">bucket</span><span class="o">.</span><span class="n">upload_from_file_object</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">parquet_data</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span>
<a id="__codelineno-117-34" name="__codelineno-117-34" href="#__codelineno-117-34"></a>    <span class="k">return</span> <span class="n">UploadResult</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">StorageBackend</span><span class="o">.</span><span class="n">S3</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<p>Sensor readings are validated with Pydantic <code>Field</code> constraints and <code>computed_field</code>
for derived values (heat index, temperature category). The <code>model_dump()</code> method
converts validated models to dicts for pandas. <code>MinIOCredentials</code> and <code>S3Bucket</code>
from prefect-aws provide the S3 client -- the same blocks work with AWS S3 or any
S3-compatible service (MinIO, RustFS). If S3 is unavailable, the flow falls back
to a local temp file.</p>
<hr />
<h3 id="dhis2-geoparquet-export">DHIS2 GeoParquet Export<a class="headerlink" href="#dhis2-geoparquet-export" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Fetch org units with geometry from DHIS2, build a
GeoDataFrame with shapely, and export to S3-compatible storage as GeoParquet
(OGC standard for geospatial data in Parquet format).</p>
<p><strong>Airflow equivalent:</strong> PythonOperator + S3Hook.upload_file() with GeoPandas.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="nd">@task</span>
<a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_geodataframe</span><span class="p">(</span><span class="n">org_units</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a>    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a>    <span class="k">for</span> <span class="n">ou</span> <span class="ow">in</span> <span class="n">org_units</span><span class="p">:</span>
<a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a>        <span class="n">geom</span> <span class="o">=</span> <span class="n">ou</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span>
<a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="p">:</span>
<a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a>            <span class="k">continue</span>
<a id="__codelineno-118-8" name="__codelineno-118-8" href="#__codelineno-118-8"></a>        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-118-9" name="__codelineno-118-9" href="#__codelineno-118-9"></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">ou</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
<a id="__codelineno-118-10" name="__codelineno-118-10" href="#__codelineno-118-10"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ou</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-118-11" name="__codelineno-118-11" href="#__codelineno-118-11"></a>            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span>
<a id="__codelineno-118-12" name="__codelineno-118-12" href="#__codelineno-118-12"></a>        <span class="p">})</span>
<a id="__codelineno-118-13" name="__codelineno-118-13" href="#__codelineno-118-13"></a>    <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
<a id="__codelineno-118-14" name="__codelineno-118-14" href="#__codelineno-118-14"></a>
<a id="__codelineno-118-15" name="__codelineno-118-15" href="#__codelineno-118-15"></a><span class="nd">@task</span>
<a id="__codelineno-118-16" name="__codelineno-118-16" href="#__codelineno-118-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">export_geoparquet</span><span class="p">(</span><span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<a id="__codelineno-118-17" name="__codelineno-118-17" href="#__codelineno-118-17"></a>    <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
<a id="__codelineno-118-18" name="__codelineno-118-18" href="#__codelineno-118-18"></a>    <span class="n">gdf</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;pyarrow&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-118-19" name="__codelineno-118-19" href="#__codelineno-118-19"></a>    <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
<a id="__codelineno-118-20" name="__codelineno-118-20" href="#__codelineno-118-20"></a>
<a id="__codelineno-118-21" name="__codelineno-118-21" href="#__codelineno-118-21"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cloud_dhis2_geoparquet_export&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-118-22" name="__codelineno-118-22" href="#__codelineno-118-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_geoparquet_export_flow</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dhis2&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExportReport</span><span class="p">:</span>
<a id="__codelineno-118-23" name="__codelineno-118-23" href="#__codelineno-118-23"></a>    <span class="n">creds</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<a id="__codelineno-118-24" name="__codelineno-118-24" href="#__codelineno-118-24"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-118-25" name="__codelineno-118-25" href="#__codelineno-118-25"></a>    <span class="n">org_units</span> <span class="o">=</span> <span class="n">fetch_org_units_with_geometry</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-118-26" name="__codelineno-118-26" href="#__codelineno-118-26"></a>    <span class="n">gdf</span> <span class="o">=</span> <span class="n">build_geodataframe</span><span class="p">(</span><span class="n">org_units</span><span class="p">)</span>
<a id="__codelineno-118-27" name="__codelineno-118-27" href="#__codelineno-118-27"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">export_geoparquet</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
<a id="__codelineno-118-28" name="__codelineno-118-28" href="#__codelineno-118-28"></a>    <span class="n">key</span><span class="p">,</span> <span class="n">backend</span> <span class="o">=</span> <span class="n">upload_to_s3</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">s3_key</span><span class="p">)</span>
<a id="__codelineno-118-29" name="__codelineno-118-29" href="#__codelineno-118-29"></a>    <span class="n">report</span> <span class="o">=</span> <span class="n">build_report</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
<a id="__codelineno-118-30" name="__codelineno-118-30" href="#__codelineno-118-30"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div>
<p><code>shapely.geometry.shape()</code> converts DHIS2 GeoJSON geometry into Shapely objects.
<code>GeoDataFrame.to_parquet()</code> writes OGC GeoParquet with embedded CRS metadata.
The same S3 upload/fallback pattern from the S3 Parquet Export flow is reused.
Multi-instance support via the <code>instance</code> parameter loads different DHIS2
credentials blocks.</p>
<hr />
<h2 id="worldpop-api">WorldPop API<a class="headerlink" href="#worldpop-api" title="Permanent link">&para;</a></h2>
<h3 id="worldpop-dataset-catalog">WorldPop Dataset Catalog<a class="headerlink" href="#worldpop-dataset-catalog" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Hierarchical REST API navigation and dataset
discovery using the WorldPop catalog API. Queries top-level datasets,
drills into sub-datasets, and filters by country ISO3 code.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator + HttpHook for REST API traversal.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">list_datasets</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DatasetRecord</span><span class="p">]:</span>
<a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a>    <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WORLDPOP_CATALOG_URL</span><span class="p">)</span>
<a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a>        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">DatasetRecord</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alias&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="o">...</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;data&quot;</span><span class="p">]]</span>
<a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a>
<a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">query_country_datasets</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subdataset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">iso3</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CountryDatasetRecord</span><span class="p">]:</span>
<a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a>    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WORLDPOP_CATALOG_URL</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">subdataset</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a>    <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-119-12" name="__codelineno-119-12" href="#__codelineno-119-12"></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iso3&quot;</span><span class="p">:</span> <span class="n">iso3</span><span class="p">})</span>
<a id="__codelineno-119-13" name="__codelineno-119-13" href="#__codelineno-119-13"></a>        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-119-14" name="__codelineno-119-14" href="#__codelineno-119-14"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">CountryDatasetRecord</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;data&quot;</span><span class="p">]]</span>
<a id="__codelineno-119-15" name="__codelineno-119-15" href="#__codelineno-119-15"></a>
<a id="__codelineno-119-16" name="__codelineno-119-16" href="#__codelineno-119-16"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cloud_worldpop_dataset_catalog&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-119-17" name="__codelineno-119-17" href="#__codelineno-119-17"></a><span class="k">def</span><span class="w"> </span><span class="nf">worldpop_dataset_catalog_flow</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">DatasetQuery</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CatalogReport</span><span class="p">:</span>
<a id="__codelineno-119-18" name="__codelineno-119-18" href="#__codelineno-119-18"></a>    <span class="n">datasets</span> <span class="o">=</span> <span class="n">list_datasets</span><span class="p">()</span>
<a id="__codelineno-119-19" name="__codelineno-119-19" href="#__codelineno-119-19"></a>    <span class="n">subdatasets</span> <span class="o">=</span> <span class="n">list_subdatasets</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-119-20" name="__codelineno-119-20" href="#__codelineno-119-20"></a>    <span class="n">country_records</span> <span class="o">=</span> <span class="n">query_country_datasets</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">subdataset</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">iso3</span><span class="p">)</span>
<a id="__codelineno-119-21" name="__codelineno-119-21" href="#__codelineno-119-21"></a>    <span class="n">report</span> <span class="o">=</span> <span class="n">build_catalog_report</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">subdatasets</span><span class="p">,</span> <span class="n">country_records</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
<a id="__codelineno-119-22" name="__codelineno-119-22" href="#__codelineno-119-22"></a>    <span class="n">create_markdown_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;worldpop-dataset-catalog&quot;</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">markdown</span><span class="p">)</span>
<a id="__codelineno-119-23" name="__codelineno-119-23" href="#__codelineno-119-23"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div>
<p>Multi-level REST API traversal with optional parameters at each level. Pydantic
models validate each API response shape. The flow produces a markdown artifact
with tables of available datasets, sub-datasets, and country records.</p>
<hr />
<h3 id="worldpop-population-stats">WorldPop Population Stats<a class="headerlink" href="#worldpop-population-stats" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> GeoJSON spatial queries against the WorldPop stats
API, with support for both synchronous and asynchronous (polling) execution
modes.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator + HttpHook with polling sensor.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">query_population</span><span class="p">(</span><span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">geojson</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">run_async</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PopulationResult</span><span class="p">:</span>
<a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;wpgppop&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="s2">&quot;geojson&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">geojson</span><span class="p">)}</span>
<a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a>    <span class="k">if</span> <span class="n">run_async</span><span class="p">:</span>
<a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a>        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;runasync&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
<a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a>    <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WORLDPOP_STATS_URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a>        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a>    <span class="k">if</span> <span class="n">run_async</span> <span class="ow">and</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;created&quot;</span><span class="p">:</span>
<a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">_poll_async_result</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;taskid&quot;</span><span class="p">])</span>
<a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a>    <span class="k">return</span> <span class="n">PopulationResult</span><span class="p">(</span><span class="n">total_population</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;total_population&quot;</span><span class="p">]),</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
</code></pre></div>
<p>GeoJSON polygons are passed as flow parameters. The async mode demonstrates a
polling pattern -- submit a job, then poll for results with timeout handling.</p>
<hr />
<h3 id="worldpop-age-sex-pyramid">WorldPop Age-Sex Pyramid<a class="headerlink" href="#worldpop-age-sex-pyramid" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Demographic data transformation from the WorldPop
age-sex stats API. Parses age-sex brackets, computes dependency ratio, sex
ratio, and median age bracket.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator + HttpHook with data transformation.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="nd">@task</span>
<a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_demographics</span><span class="p">(</span><span class="n">brackets</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AgeSexBracket</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DemographicStats</span><span class="p">:</span>
<a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a>    <span class="n">total_male</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">male</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">brackets</span><span class="p">)</span>
<a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>    <span class="n">total_female</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">female</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">brackets</span><span class="p">)</span>
<a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a>    <span class="n">sex_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_male</span> <span class="o">/</span> <span class="n">total_female</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">total_female</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a>    <span class="n">young</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">total</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">brackets</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a>    <span class="n">old</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">total</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">brackets</span><span class="p">[</span><span class="mi">13</span><span class="p">:])</span>
<a id="__codelineno-121-8" name="__codelineno-121-8" href="#__codelineno-121-8"></a>    <span class="n">working_age</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">total</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">brackets</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">13</span><span class="p">])</span>
<a id="__codelineno-121-9" name="__codelineno-121-9" href="#__codelineno-121-9"></a>    <span class="n">dependency_ratio</span> <span class="o">=</span> <span class="p">((</span><span class="n">young</span> <span class="o">+</span> <span class="n">old</span><span class="p">)</span> <span class="o">/</span> <span class="n">working_age</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">working_age</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-121-10" name="__codelineno-121-10" href="#__codelineno-121-10"></a>    <span class="k">return</span> <span class="n">DemographicStats</span><span class="p">(</span><span class="n">sex_ratio</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">sex_ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dependency_ratio</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">dependency_ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<p>Complex API response parsing into typed Pydantic models. Computed statistics
(dependency ratio, sex ratio) demonstrate data transformation patterns. The
markdown artifact includes both a tabular pyramid and summary statistics.</p>
<hr />
<h3 id="worldpop-country-comparison">WorldPop Country Comparison<a class="headerlink" href="#worldpop-country-comparison" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Parallel multi-country queries using <code>.map()</code>,
aggregation, and comparison table generation.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator in a loop or dynamic task mapping.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cloud_worldpop_country_comparison&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">worldpop_country_comparison_flow</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">ComparisonQuery</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ComparisonReport</span><span class="p">:</span>
<a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="n">fetch_country_metadata</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a>        <span class="n">query</span><span class="o">.</span><span class="n">iso3_codes</span><span class="p">,</span>
<a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a>        <span class="n">dataset</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span>
<a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a>        <span class="n">subdataset</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">subdataset</span><span class="p">,</span>
<a id="__codelineno-122-7" name="__codelineno-122-7" href="#__codelineno-122-7"></a>        <span class="n">year</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
<a id="__codelineno-122-8" name="__codelineno-122-8" href="#__codelineno-122-8"></a>    <span class="p">)</span>
<a id="__codelineno-122-9" name="__codelineno-122-9" href="#__codelineno-122-9"></a>    <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
<a id="__codelineno-122-10" name="__codelineno-122-10" href="#__codelineno-122-10"></a>    <span class="n">sorted_records</span> <span class="o">=</span> <span class="n">aggregate_comparison</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<a id="__codelineno-122-11" name="__codelineno-122-11" href="#__codelineno-122-11"></a>    <span class="n">report</span> <span class="o">=</span> <span class="n">build_comparison_report</span><span class="p">(</span><span class="n">sorted_records</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
<a id="__codelineno-122-12" name="__codelineno-122-12" href="#__codelineno-122-12"></a>    <span class="n">create_markdown_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;worldpop-country-comparison&quot;</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">markdown</span><span class="p">)</span>
<a id="__codelineno-122-13" name="__codelineno-122-13" href="#__codelineno-122-13"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div>
<p><code>.map()</code> fans out one API call per country in parallel. Results are collected
and aggregated into a sorted comparison table. The flow demonstrates Prefect's
dynamic mapping pattern with real API calls.</p>
<hr />
<h3 id="worldpop-country-report">WorldPop Country Report<a class="headerlink" href="#worldpop-country-report" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Multi-source API aggregation -- WorldPop catalog
metadata enriched with population numbers from the World Bank API -- followed
by Slack notification via webhook.</p>
<p><strong>External APIs:</strong>
- <strong>WorldPop catalog API</strong> (<code>hub.worldpop.org/rest/data</code>) -- dataset metadata
  and year-range availability per country.
- <strong>World Bank API</strong> (<code>api.worldbank.org/v2</code>) -- country-level population by
  ISO3 code and year (indicator <code>SP.POP.TOTL</code>).</p>
<p><strong>Airflow equivalent:</strong> PythonOperator + HttpHook + SlackWebhookOperator.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cloud_worldpop_country_report&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">worldpop_country_report_flow</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">CountryReportQuery</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PopulationReport</span><span class="p">:</span>
<a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="n">fetch_country_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">iso3_codes</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">subdataset</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">subdataset</span><span class="p">)</span>
<a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a>    <span class="n">raw_countries</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
<a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a>    <span class="n">pop_data</span> <span class="o">=</span> <span class="n">fetch_population</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">iso3_codes</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
<a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">raw_countries</span><span class="p">:</span>
<a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a>        <span class="n">c</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="n">pop_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">iso3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-123-8" name="__codelineno-123-8" href="#__codelineno-123-8"></a>    <span class="n">countries</span> <span class="o">=</span> <span class="n">transform_results</span><span class="p">(</span><span class="n">raw_countries</span><span class="p">)</span>
<a id="__codelineno-123-9" name="__codelineno-123-9" href="#__codelineno-123-9"></a>    <span class="n">markdown</span> <span class="o">=</span> <span class="n">build_report</span><span class="p">(</span><span class="n">countries</span><span class="p">)</span>
<a id="__codelineno-123-10" name="__codelineno-123-10" href="#__codelineno-123-10"></a>    <span class="n">create_markdown_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;worldpop-country-report&quot;</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="n">markdown</span><span class="p">)</span>
<a id="__codelineno-123-11" name="__codelineno-123-11" href="#__codelineno-123-11"></a>    <span class="n">slack_sent</span> <span class="o">=</span> <span class="n">send_slack_notification</span><span class="p">(</span><span class="n">countries</span><span class="p">)</span>
<a id="__codelineno-123-12" name="__codelineno-123-12" href="#__codelineno-123-12"></a>    <span class="k">return</span> <span class="n">PopulationReport</span><span class="p">(</span><span class="n">countries</span><span class="o">=</span><span class="n">countries</span><span class="p">,</span> <span class="n">total_countries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">countries</span><span class="p">),</span> <span class="n">markdown</span><span class="o">=</span><span class="n">markdown</span><span class="p">,</span> <span class="n">slack_sent</span><span class="o">=</span><span class="n">slack_sent</span><span class="p">)</span>
</code></pre></div>
<p>The World Bank batch endpoint accepts semicolon-separated ISO3 codes in a
single request, avoiding per-country fan-out for population data. Results are
merged into the WorldPop metadata before sorting by population descending.</p>
<hr />
<h3 id="worldpop-population-time-series">WorldPop Population Time-Series<a class="headerlink" href="#worldpop-population-time-series" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Time-series construction from sequential API queries,
year-over-year growth rate computation, and peak growth identification.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator loop with HttpHook for paginated API.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="nd">@task</span>
<a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_growth_rates</span><span class="p">(</span><span class="n">year_records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">YearMetadata</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">GrowthRate</span><span class="p">]:</span>
<a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a>    <span class="n">growth_rates</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-124-4" name="__codelineno-124-4" href="#__codelineno-124-4"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">year_records</span><span class="p">)):</span>
<a id="__codelineno-124-5" name="__codelineno-124-5" href="#__codelineno-124-5"></a>        <span class="n">prev_year</span> <span class="o">=</span> <span class="n">year_records</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">year</span>
<a id="__codelineno-124-6" name="__codelineno-124-6" href="#__codelineno-124-6"></a>        <span class="n">curr_year</span> <span class="o">=</span> <span class="n">year_records</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">year</span>
<a id="__codelineno-124-7" name="__codelineno-124-7" href="#__codelineno-124-7"></a>        <span class="n">year_gap</span> <span class="o">=</span> <span class="n">curr_year</span> <span class="o">-</span> <span class="n">prev_year</span>
<a id="__codelineno-124-8" name="__codelineno-124-8" href="#__codelineno-124-8"></a>        <span class="n">compound_rate</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">**</span> <span class="n">year_gap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<a id="__codelineno-124-9" name="__codelineno-124-9" href="#__codelineno-124-9"></a>        <span class="n">growth_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GrowthRate</span><span class="p">(</span><span class="n">from_year</span><span class="o">=</span><span class="n">prev_year</span><span class="p">,</span> <span class="n">to_year</span><span class="o">=</span><span class="n">curr_year</span><span class="p">,</span> <span class="n">growth_rate_pct</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">compound_rate</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<a id="__codelineno-124-10" name="__codelineno-124-10" href="#__codelineno-124-10"></a>    <span class="k">return</span> <span class="n">growth_rates</span>
</code></pre></div>
<p>Sequential API pagination over available years for a single country. Growth
rates are computed from consecutive year metadata. The markdown artifact
includes both the year listing and a growth rate table with peak identification.</p>
<hr />
<h2 id="world-bank-api">World Bank API<a class="headerlink" href="#world-bank-api" title="Permanent link">&para;</a></h2>
<h3 id="world-bank-gdp-comparison">World Bank GDP Comparison<a class="headerlink" href="#world-bank-gdp-comparison" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Batch multi-country API call to the World Bank
indicators endpoint, ranking and report generation.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator + HttpHook for REST API with data
ranking.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">fetch_gdp_data</span><span class="p">(</span><span class="n">iso3_codes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CountryGdp</span><span class="p">]:</span>
<a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a>    <span class="n">codes</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iso3_codes</span><span class="p">)</span>
<a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a>    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WORLDBANK_API_URL</span><span class="si">}</span><span class="s2">/country/</span><span class="si">{</span><span class="n">codes</span><span class="si">}</span><span class="s2">/indicator/NY.GDP.MKTP.CD&quot;</span>
<a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;per_page&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iso3_codes</span><span class="p">))}</span>
<a id="__codelineno-125-6" name="__codelineno-125-6" href="#__codelineno-125-6"></a>    <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-125-7" name="__codelineno-125-7" href="#__codelineno-125-7"></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-125-8" name="__codelineno-125-8" href="#__codelineno-125-8"></a>        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-125-9" name="__codelineno-125-9" href="#__codelineno-125-9"></a>    <span class="o">...</span>
<a id="__codelineno-125-10" name="__codelineno-125-10" href="#__codelineno-125-10"></a>
<a id="__codelineno-125-11" name="__codelineno-125-11" href="#__codelineno-125-11"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cloud_worldbank_gdp_comparison&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-125-12" name="__codelineno-125-12" href="#__codelineno-125-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">worldbank_gdp_comparison_flow</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">GdpComparisonQuery</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GdpComparisonReport</span><span class="p">:</span>
<a id="__codelineno-125-13" name="__codelineno-125-13" href="#__codelineno-125-13"></a>    <span class="n">countries</span> <span class="o">=</span> <span class="n">fetch_gdp_data</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">iso3_codes</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
<a id="__codelineno-125-14" name="__codelineno-125-14" href="#__codelineno-125-14"></a>    <span class="n">ranked</span> <span class="o">=</span> <span class="n">rank_by_gdp</span><span class="p">(</span><span class="n">countries</span><span class="p">)</span>
<a id="__codelineno-125-15" name="__codelineno-125-15" href="#__codelineno-125-15"></a>    <span class="n">markdown</span> <span class="o">=</span> <span class="n">build_gdp_report</span><span class="p">(</span><span class="n">ranked</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
<a id="__codelineno-125-16" name="__codelineno-125-16" href="#__codelineno-125-16"></a>    <span class="n">create_markdown_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;worldbank-gdp-comparison&quot;</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="n">markdown</span><span class="p">)</span>
<a id="__codelineno-125-17" name="__codelineno-125-17" href="#__codelineno-125-17"></a>    <span class="k">return</span> <span class="n">GdpComparisonReport</span><span class="p">(</span><span class="n">countries</span><span class="o">=</span><span class="n">ranked</span><span class="p">,</span> <span class="n">total_countries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ranked</span><span class="p">),</span> <span class="n">markdown</span><span class="o">=</span><span class="n">markdown</span><span class="p">)</span>
</code></pre></div>
<p>The World Bank batch endpoint accepts semicolon-separated ISO3 codes, avoiding
per-country fan-out. GDP values are ranked descending with summary statistics.</p>
<hr />
<h3 id="world-bank-indicator-time-series">World Bank Indicator Time-Series<a class="headerlink" href="#world-bank-indicator-time-series" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Time-series construction from a single World Bank
indicator over a year range, with year-over-year growth rate computation and
peak/trough identification.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator loop with HttpHook for paginated API.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">fetch_indicator_timeseries</span><span class="p">(</span><span class="n">iso3</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start_year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_year</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">YearValue</span><span class="p">]:</span>
<a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a>    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WORLDBANK_API_URL</span><span class="si">}</span><span class="s2">/country/</span><span class="si">{</span><span class="n">iso3</span><span class="si">}</span><span class="s2">/indicator/</span><span class="si">{</span><span class="n">indicator</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_year</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;per_page&quot;</span><span class="p">:</span> <span class="s2">&quot;100&quot;</span><span class="p">}</span>
<a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a>    <span class="o">...</span>
<a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a>
<a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a><span class="nd">@task</span>
<a id="__codelineno-126-8" name="__codelineno-126-8" href="#__codelineno-126-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_growth_rates</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">YearValue</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">GrowthRate</span><span class="p">]:</span>
<a id="__codelineno-126-9" name="__codelineno-126-9" href="#__codelineno-126-9"></a>    <span class="n">rates</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-126-10" name="__codelineno-126-10" href="#__codelineno-126-10"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
<a id="__codelineno-126-11" name="__codelineno-126-11" href="#__codelineno-126-11"></a>        <span class="n">growth</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="mi">100</span>
<a id="__codelineno-126-12" name="__codelineno-126-12" href="#__codelineno-126-12"></a>        <span class="n">rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GrowthRate</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">growth_pct</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">growth</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
<a id="__codelineno-126-13" name="__codelineno-126-13" href="#__codelineno-126-13"></a>    <span class="k">return</span> <span class="n">rates</span>
</code></pre></div>
<p>Year-range queries use <code>date=2000:2023</code> syntax. Null values from the API are
filtered before growth rate computation. Peak and trough growth years are
identified in the report summary.</p>
<hr />
<h3 id="world-bank-country-profile">World Bank Country Profile<a class="headerlink" href="#world-bank-country-profile" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Multi-indicator aggregation using <code>.map()</code> to query
several different World Bank indicators for a single country in parallel.
Builds a dashboard-style country profile.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator with multiple HttpHook calls.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="n">DEFAULT_INDICATORS</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a>    <span class="s2">&quot;SP.POP.TOTL&quot;</span><span class="p">,</span>      <span class="c1"># Population</span>
<a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a>    <span class="s2">&quot;NY.GDP.MKTP.CD&quot;</span><span class="p">,</span>   <span class="c1"># GDP (current US$)</span>
<a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a>    <span class="s2">&quot;NY.GDP.PCAP.CD&quot;</span><span class="p">,</span>   <span class="c1"># GDP per capita</span>
<a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a>    <span class="s2">&quot;SP.DYN.LE00.IN&quot;</span><span class="p">,</span>   <span class="c1"># Life expectancy</span>
<a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a>    <span class="s2">&quot;SE.ADT.LITR.ZS&quot;</span><span class="p">,</span>   <span class="c1"># Literacy rate</span>
<a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a>    <span class="s2">&quot;SH.DYN.MORT&quot;</span><span class="p">,</span>      <span class="c1"># Under-5 mortality rate</span>
<a id="__codelineno-127-8" name="__codelineno-127-8" href="#__codelineno-127-8"></a><span class="p">]</span>
<a id="__codelineno-127-9" name="__codelineno-127-9" href="#__codelineno-127-9"></a>
<a id="__codelineno-127-10" name="__codelineno-127-10" href="#__codelineno-127-10"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cloud_worldbank_country_profile&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-127-11" name="__codelineno-127-11" href="#__codelineno-127-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">worldbank_country_profile_flow</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">ProfileQuery</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CountryProfile</span><span class="p">:</span>
<a id="__codelineno-127-12" name="__codelineno-127-12" href="#__codelineno-127-12"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="n">fetch_indicator</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">iso3</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">indicators</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
<a id="__codelineno-127-13" name="__codelineno-127-13" href="#__codelineno-127-13"></a>    <span class="n">indicators</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
<a id="__codelineno-127-14" name="__codelineno-127-14" href="#__codelineno-127-14"></a>    <span class="n">profile</span> <span class="o">=</span> <span class="n">build_country_profile</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">iso3</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">indicators</span><span class="p">)</span>
<a id="__codelineno-127-15" name="__codelineno-127-15" href="#__codelineno-127-15"></a>    <span class="n">create_markdown_artifact</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;worldbank-country-profile&quot;</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">markdown</span><span class="p">)</span>
<a id="__codelineno-127-16" name="__codelineno-127-16" href="#__codelineno-127-16"></a>    <span class="k">return</span> <span class="n">profile</span>
</code></pre></div>
<p><code>.map()</code> parallelises one API call per indicator. Value formatting adapts to
indicator type: percentages for rate indicators (<code>.ZS</code> suffix), dollar
formatting for large monetary values, and comma-separated integers for counts.</p>
<hr />
<h3 id="world-bank-poverty-analysis">World Bank Poverty Analysis<a class="headerlink" href="#world-bank-poverty-analysis" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Handling sparse/missing data common with development
indicators. Uses <code>.map()</code> for parallel country queries, trend detection, and
robust null-value handling.</p>
<p><strong>Airflow equivalent:</strong> PythonOperator in a loop with missing-data handling.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="nd">@task</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retry_delay_seconds</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">fetch_poverty_data</span><span class="p">(</span><span class="n">iso3</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start_year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_year</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CountryPoverty</span><span class="p">:</span>
<a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a>    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WORLDBANK_API_URL</span><span class="si">}</span><span class="s2">/country/</span><span class="si">{</span><span class="n">iso3</span><span class="si">}</span><span class="s2">/indicator/SI.POV.DDAY&quot;</span>
<a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a>    <span class="o">...</span>
<a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a>    <span class="c1"># Filter null values, find latest data point, determine trend</span>
<a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a>        <span class="n">diff</span> <span class="o">=</span> <span class="n">latest_value</span> <span class="o">-</span> <span class="n">earliest_value</span>
<a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a>        <span class="n">trend</span> <span class="o">=</span> <span class="s2">&quot;improving&quot;</span> <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;worsening&quot;</span> <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;stable&quot;</span>
</code></pre></div>
<p>Poverty data (<code>SI.POV.DDAY</code> -- headcount ratio at $2.15/day) is notoriously
sparse, with many countries missing recent data points. The flow demonstrates
robust handling of null API values, trend detection from available data, and
sorting that separates countries with data from those without.</p>
<hr />
<h2 id="deployments-directory">Deployments directory<a class="headerlink" href="#deployments-directory" title="Permanent link">&para;</a></h2>
<p>Production deployment examples live in the <code>deployments/</code> directory. Each
subdirectory is a self-contained deployment with its own <code>flow.py</code>,
<code>prefect.yaml</code>, and <code>deploy.py</code>.</p>
<h3 id="dhis2_connection-dhis2-connection-check">dhis2_connection -- DHIS2 Connection Check<a class="headerlink" href="#dhis2_connection-dhis2-connection-check" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Verifies DHIS2 connectivity, fetches the org unit
count, and produces a connection status artifact.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_connection&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_connection_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ConnectionReport</span><span class="p">:</span>
<a id="__codelineno-129-3" name="__codelineno-129-3" href="#__codelineno-129-3"></a>    <span class="n">creds</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">()</span>
<a id="__codelineno-129-4" name="__codelineno-129-4" href="#__codelineno-129-4"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-129-5" name="__codelineno-129-5" href="#__codelineno-129-5"></a>    <span class="n">server_info</span> <span class="o">=</span> <span class="n">verify_connection</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-129-6" name="__codelineno-129-6" href="#__codelineno-129-6"></a>    <span class="n">count</span> <span class="o">=</span> <span class="n">fetch_org_unit_count</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-129-7" name="__codelineno-129-7" href="#__codelineno-129-7"></a>    <span class="n">report</span> <span class="o">=</span> <span class="n">build_report</span><span class="p">(</span><span class="n">creds</span><span class="p">,</span> <span class="n">server_info</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
<a id="__codelineno-129-8" name="__codelineno-129-8" href="#__codelineno-129-8"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div>
<h3 id="dhis2_block_connection-dhis2-block-connection">dhis2_block_connection -- DHIS2 Block Connection<a class="headerlink" href="#dhis2_block_connection-dhis2-block-connection" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Verifies DHIS2 connectivity using a named credentials
block, fetches the org unit count, and produces a connection status artifact.
Supports multi-instance deployment via the <code>instance</code> parameter.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_block_connection&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-130-2" name="__codelineno-130-2" href="#__codelineno-130-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_block_connection_flow</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dhis2&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConnectionReport</span><span class="p">:</span>
<a id="__codelineno-130-3" name="__codelineno-130-3" href="#__codelineno-130-3"></a>    <span class="n">creds</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<a id="__codelineno-130-4" name="__codelineno-130-4" href="#__codelineno-130-4"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-130-5" name="__codelineno-130-5" href="#__codelineno-130-5"></a>    <span class="n">server_info</span> <span class="o">=</span> <span class="n">verify_connection</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-130-6" name="__codelineno-130-6" href="#__codelineno-130-6"></a>    <span class="n">count</span> <span class="o">=</span> <span class="n">fetch_org_unit_count</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-130-7" name="__codelineno-130-7" href="#__codelineno-130-7"></a>    <span class="n">report</span> <span class="o">=</span> <span class="n">build_report</span><span class="p">(</span><span class="n">creds</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">server_info</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
<a id="__codelineno-130-8" name="__codelineno-130-8" href="#__codelineno-130-8"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div>
<h3 id="dhis2_ou-dhis2-organisation-units">dhis2_ou -- DHIS2 Organisation Units<a class="headerlink" href="#dhis2_ou-dhis2-organisation-units" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> A deployment-ready flow that fetches DHIS2
organisation units and produces a markdown artifact listing each unit's
ID and display name.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_ou&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-131-2" name="__codelineno-131-2" href="#__codelineno-131-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_ou_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">OrgUnitReport</span><span class="p">:</span>
<a id="__codelineno-131-3" name="__codelineno-131-3" href="#__codelineno-131-3"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-131-4" name="__codelineno-131-4" href="#__codelineno-131-4"></a>    <span class="n">org_units</span> <span class="o">=</span> <span class="n">fetch_org_units</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-131-5" name="__codelineno-131-5" href="#__codelineno-131-5"></a>    <span class="n">report</span> <span class="o">=</span> <span class="n">build_report</span><span class="p">(</span><span class="n">org_units</span><span class="p">)</span>
<a id="__codelineno-131-6" name="__codelineno-131-6" href="#__codelineno-131-6"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div>
<p>Key patterns demonstrated:</p>
<ul>
<li><strong><code>prefect.runtime</code></strong> -- <code>deployment.name</code> provides deployment-aware
  context (falls back to "local" for direct runs)</li>
<li><strong>Block reference</strong> -- <code>get_dhis2_credentials()</code> loads credentials from a
  saved block or falls back to inline defaults</li>
<li><strong>Markdown artifact</strong> -- <code>create_markdown_artifact</code> produces a table
  visible in the Prefect UI artifacts tab</li>
<li><strong>Per-deployment <code>prefect.yaml</code></strong> -- declarative config lives alongside
  the flow code</li>
</ul>
<p>Deploy with <code>prefect.yaml</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a><span class="nt">deployments</span><span class="p">:</span>
<a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dhis2-ou</span>
<a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flow.py:dhis2_ou_flow</span>
<a id="__codelineno-132-4" name="__codelineno-132-4" href="#__codelineno-132-4"></a><span class="w">    </span><span class="nt">schedules</span><span class="p">:</span>
<a id="__codelineno-132-5" name="__codelineno-132-5" href="#__codelineno-132-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cron</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0</span><span class="nv"> </span><span class="s">6</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span>
<a id="__codelineno-132-6" name="__codelineno-132-6" href="#__codelineno-132-6"></a><span class="w">        </span><span class="nt">timezone</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;UTC&quot;</span>
<a id="__codelineno-132-7" name="__codelineno-132-7" href="#__codelineno-132-7"></a><span class="w">    </span><span class="nt">work_pool</span><span class="p">:</span>
<a id="__codelineno-132-8" name="__codelineno-132-8" href="#__codelineno-132-8"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</code></pre></div>
<p>Manage after deployment:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a><span class="nb">cd</span><span class="w"> </span>deployments/dhis2_ou<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>prefect<span class="w"> </span>deploy<span class="w"> </span>--all<span class="w">   </span><span class="c1"># register deployment</span>
<a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a>prefect<span class="w"> </span>deployment<span class="w"> </span>run<span class="w"> </span>dhis2_ou/dhis2-ou<span class="w">           </span><span class="c1"># trigger run</span>
<a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a>prefect<span class="w"> </span>deployment<span class="w"> </span>set-schedule<span class="w"> </span>&lt;name&gt;<span class="w"> </span>--cron<span class="w"> </span><span class="s2">&quot;0 8 * * *&quot;</span><span class="w">     </span><span class="c1"># change schedule</span>
<a id="__codelineno-133-4" name="__codelineno-133-4" href="#__codelineno-133-4"></a>prefect<span class="w"> </span>deployment<span class="w"> </span>pause<span class="w"> </span>&lt;name&gt;<span class="w">                   </span><span class="c1"># pause scheduling</span>
<a id="__codelineno-133-5" name="__codelineno-133-5" href="#__codelineno-133-5"></a>prefect<span class="w"> </span>deployment<span class="w"> </span>resume<span class="w"> </span>&lt;name&gt;<span class="w">                  </span><span class="c1"># resume scheduling</span>
</code></pre></div>
<h3 id="s3_parquet_export-s3-parquet-export">s3_parquet_export -- S3 Parquet Export<a class="headerlink" href="#s3_parquet_export-s3-parquet-export" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Deployment wrapper for the S3 Parquet Export flow
that generates sample sensor data, transforms with pandas, and writes parquet
to S3-compatible storage.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;s3_parquet_export&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">s3_parquet_export_flow</span><span class="p">(</span><span class="n">n_records</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExportResult</span><span class="p">:</span>
<a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a>    <span class="n">readings</span> <span class="o">=</span> <span class="n">generate_records</span><span class="p">(</span><span class="n">n_records</span><span class="p">)</span>
<a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a>    <span class="n">transform</span> <span class="o">=</span> <span class="n">transform_to_dataframe</span><span class="p">(</span><span class="n">readings</span><span class="p">)</span>
<a id="__codelineno-134-5" name="__codelineno-134-5" href="#__codelineno-134-5"></a>    <span class="n">upload</span> <span class="o">=</span> <span class="n">upload_to_s3</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">s3_key</span><span class="p">)</span>
<a id="__codelineno-134-6" name="__codelineno-134-6" href="#__codelineno-134-6"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">verify_upload</span><span class="p">(</span><span class="n">upload</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>
<a id="__codelineno-134-7" name="__codelineno-134-7" href="#__codelineno-134-7"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<h3 id="dhis2_geoparquet_export-dhis2-geoparquet-export">dhis2_geoparquet_export -- DHIS2 GeoParquet Export<a class="headerlink" href="#dhis2_geoparquet_export-dhis2-geoparquet-export" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> A deployment-ready flow that fetches DHIS2 org units
with geometry, builds a GeoDataFrame, and exports GeoParquet to S3. Supports
multi-instance deployment via the <code>instance</code> parameter.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_geoparquet_export&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_geoparquet_export_flow</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dhis2&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExportReport</span><span class="p">:</span>
<a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a>    <span class="n">creds</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-135-5" name="__codelineno-135-5" href="#__codelineno-135-5"></a>    <span class="n">org_units</span> <span class="o">=</span> <span class="n">fetch_org_units_with_geometry</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-135-6" name="__codelineno-135-6" href="#__codelineno-135-6"></a>    <span class="n">gdf</span> <span class="o">=</span> <span class="n">build_geodataframe</span><span class="p">(</span><span class="n">org_units</span><span class="p">)</span>
<a id="__codelineno-135-7" name="__codelineno-135-7" href="#__codelineno-135-7"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">export_geoparquet</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
<a id="__codelineno-135-8" name="__codelineno-135-8" href="#__codelineno-135-8"></a>    <span class="n">key</span><span class="p">,</span> <span class="n">backend</span> <span class="o">=</span> <span class="n">upload_to_s3</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">s3_key</span><span class="p">)</span>
<a id="__codelineno-135-9" name="__codelineno-135-9" href="#__codelineno-135-9"></a>    <span class="n">report</span> <span class="o">=</span> <span class="n">build_report</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
<a id="__codelineno-135-10" name="__codelineno-135-10" href="#__codelineno-135-10"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div>
<h3 id="dhis2_worldpop_population_import-dhis2-worldpop-population-import">dhis2_worldpop_population_import -- DHIS2 WorldPop Population Import<a class="headerlink" href="#dhis2_worldpop_population_import-dhis2-worldpop-population-import" title="Permanent link">&para;</a></h3>
<p><strong>What it demonstrates:</strong> Deployment wrapper for the WorldPop population import
flow that reads org unit polygon geometry from DHIS2, queries the WorldPop
age-sex API, and writes sex-disaggregated population values back using category
combinations.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="nd">@flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dhis2_worldpop_population_import&quot;</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dhis2_worldpop_population_import_flow</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">ImportQuery</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImportResult</span><span class="p">:</span>
<a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_dhis2_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
<a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a>    <span class="n">org_units</span><span class="p">,</span> <span class="n">coc_mapping</span> <span class="o">=</span> <span class="n">ensure_dhis2_metadata</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a>    <span class="k">for</span> <span class="n">ou</span> <span class="ow">in</span> <span class="n">org_units</span><span class="p">:</span>
<a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a>        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fetch_worldpop_population</span><span class="p">(</span><span class="n">ou</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
<a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a>    <span class="n">data_values</span> <span class="o">=</span> <span class="n">build_data_values</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">coc_mapping</span><span class="p">)</span>
<a id="__codelineno-136-8" name="__codelineno-136-8" href="#__codelineno-136-8"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">import_to_dhis2</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dhis2_url</span><span class="p">,</span> <span class="n">org_units</span><span class="p">,</span> <span class="n">data_values</span><span class="p">)</span>
<a id="__codelineno-136-9" name="__codelineno-136-9" href="#__codelineno-136-9"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>